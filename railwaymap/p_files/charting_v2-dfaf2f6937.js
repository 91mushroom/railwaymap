/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2019.3.18
 ************************************************/
charting.service("chartService",["$http","$q","$timeout",function(e,t,i){function r(e){if(e.simpleJson.dom&&""!==e.simpleJson.dom){var t=a(e.simpleJson);if(t.instance){t.dispose();for(var i in e.simpleJson.data.properties)e.simpleJson.data.properties[i].bind=[]}}}function n(i,r,n,a){var o={method:"post",url:datavizOption.chartedit.rest.chartData,headers:{"X-Date":(new Date).toUTCString()},data:{datasetId:i,bindFields:r,conditions:n,dataSetBindings:a}},s=t.defer();return datavizOption.chartedit.chartData.getChartDataByRest?e(o).then(function(e){e.data.error?s.reject(e.data.error):s.resolve(e.data.object)},function(e){console.error(e)}):datavizOption.chartedit.chartData.getBindData?s.resolve(datavizOption.chartedit.chartData.getBindData()):s.reject("chartData.getBindData is undefined !"),s.promise}function a(e){if(e.data){var t={};return t.dom=e.dom,t.themeName=e.themeName,t.data=angular.copy(e.data),t.option=angular.copy(e.option),ChartParse.getChartsInstance(t)}}function o(i,r){var n={method:"post",url:datavizOption.chartedit.rest.drillThrough,headers:{"X-Date":(new Date).toUTCString()},data:{datasetId:i,conditions:r}},a=t.defer();return datavizOption.chartedit.chartData.getChartDrillDataByRest?e(n).then(function(e){e.data.error?a.reject(e.data.error):a.resolve(e.data.object)},function(e){console.error(e)}):datavizOption.chartedit.chartData.getDrillData?a.resolve(datavizOption.chartedit.chartData.getDrillData()):a.reject("chartData.getDrillData is undefined !"),a.promise}function s(e,t){var i={},r=[];k.chartbookId=e;for(var n=0,a=t.length;a>n;n++){var o=t[n].l.dataset+t[n].r.dataset,s=t[n].r.dataset+t[n].l.dataset;if(i[o]||i[s])i[o]?i[o].fields.push({field1:t[n].l.field,field2:t[n].r.field}):i[s]&&i[s].fields.push({field1:t[n].r.field,field2:t[n].l.field});else{var d={};d.ds1=t[n].l.dataset,d.ds2=t[n].r.dataset,d.fields=[],d.fields.push({field1:t[n].l.field,field2:t[n].r.field}),i[o]=d,r.push(d)}}k.dataSetBindings=r}function d(e){var t,i=[],r=[];for(i.push(e),t=p(i),t&&(i.push(t.dsId),r.push(t.bindings));t&&!t.over;)t=p(i),t&&(i.push(t.dsId),r.push(t.bindings));return r}function p(e){for(var t=0,i=k.dataSetBindings.length;i>t;t++){var r=k.dataSetBindings[t];if(-1!==_.indexOf(e,r.ds1)){if(-1===_.indexOf(e,r.ds2))return{dsId:r.ds2,bindings:r,over:t===i-1}}else if(-1!==_.indexOf(e,r.ds2))return{dsId:r.ds1,bindings:r,over:t===i-1}}}function c(e){return C[e]}function l(e,t){C[e]=t}function u(e){delete C[e]}function h(e){return f(e)}function f(e){var t={};for(var i in e)if(e[i].type&&"Array"===e[i].type[0])if(t[i]=[],e[i].items&&e[i].items.anyOf){var r=f(e[i].items.anyOf);for(var n in r)r[n][0]?t[i].push(r[n][0]):t[i].push(r[n])}else if(e[i].items)t[i].push(f(e[i].items.properties));else if(e[i].properties)t[i].push(f(e[i].properties));else{var a=e[i]["default"];if(a)for(var o in a)t[i].push(a[o])}else if(e[i].properties)t[i]=f(e[i].properties);else if(e[i].type&&"segmentLine"===e[i].type[0]){var s={};s.items={},s.items.start=e[i].items.start["default"],e[i].items.color?s.items.color=e[i].items.color["default"]:s.items.end=e[i].items.end["default"],t[i]=s}else t[i]=e[i]["default"];return t}function m(e,t){return g(e,t)}function g(e,t){function i(e){var t={};for(var r in e)t[r]="object"==typeof e[r]?i(e[r]):e[r];return t}var r={};for(var n in e)if(t.properties[n])if(_.isArray(e[n])&&0!==e[n].length)"series"===n||"seriesLeft"===n||"seriesRight"===n||"dataZoom"===n||"visualMap"===n||"grid"===n||"data"===n?(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n].items={},r[n].items.anyOf=[],_.each(e[n],function(e,i){var a={};a.name=t.properties[n].name,a.type=t.properties[n].type,a.isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),t.properties[n].items.anyOf&&(a.properties=g(e,t.properties[n].items.anyOf[i])),r[n].items.anyOf.push(a)})):"xAxis"===n||"yAxis"===n||"parallelAxis"===n?(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),_.each(e[n],function(e,i){if(t.properties[n].items&&t.properties[n].items.anyOf){r[n].items&&r[n].items.anyOf||(r[n].items={},r[n].items.anyOf=[]);var a={};a.name=t.properties[n].name,a.type=t.properties[n].type,a.isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),a.properties=g(e,t.properties[n].items.anyOf[i]),r[n].items.anyOf.push(a)}else t.properties[n].properties&&(r[n].properties=g(e,t.properties[n]))})):"radius"===n?(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n]["default"]=e[n]):"symbolSize"===n?(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n]["default"]=e[n]):"color"===n||"colorSaturation"===n?(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n]["default"]=e[n]):"singleAxis"===n&&(r[n]={},r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n].properties={},_.each(e[n],function(e,i){var a={};a=g(e,t.properties[n]),r[n].properties=a}));else if(_.isObject(e[n]))if(r[n]={},t.properties[n]&&"segmentsArray"===n){r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n].properties={};for(element in e[n]){var a=i(t.properties[n].properties[1e3]);a.name="第"+(1*element+1)%1e3+"段",a.items.start["default"]=e[n][element].items.start,e[n][element].items.color?a.items.color["default"]=e[n][element].items.color:a.items.end["default"]=e[n][element].items.end,r[n].properties[element]=a}}else t.properties[n]&&(r[n].name=t.properties[n].name,r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n].properties=g(e[n],t.properties[n]));else r[n]={},t.properties[n]&&(r[n].name=t.properties[n].name,t.properties[n].items&&(r[n].items=t.properties[n].items),r[n].type=t.properties[n].type,r[n].isShow=t.properties[n].isShow,"undefined"!=typeof t.properties[n].max&&(r[n].max=t.properties[n].max),"undefined"!=typeof t.properties[n].min&&(r[n].min=t.properties[n].min),r[n]["default"]=e[n]);return r}function b(e){var t=/^-?(((\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE])(\d+\.?|\d+,?)+)|((\d+\.?|\d+,?)+(\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE]))$)/,i=/^-?(\d+\.?|\d+,?)+%$/,r=/^-?(\d+\.?,?)+\d+$/,n=/^-?\d+(\.\d+)?$/,a=/^\s+|\s+$/,o=e.simpleJson,s=o.data["default"],d=o.data.properties;if(s&&d){for(var p=0;p<s[0].length;p++)"string"==typeof s[0][p]&&(s[0][p]=s[0][p].replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")"));for(var c in d)if(d.hasOwnProperty(c)){var l=d[c].bind;if(!(l.length<1))for(var p=0;p<l.length;p++){var u=l[p].fieldName,h=_.indexOf(s[0],u);h>-1&&_.each(s,function(e,o){var s=e[h];if("string"==typeof s&&0!==o){var d=s;t.test(d)&&(d=d.replace(/(\uFFE5|\u0024|\u00A2|\u00A3|\u00A4|\u00A5|[\u20A0-\u20BE])/,"")),i.test(d)&&(d=d.replace("%","")),a.test(d)&&(d=d.replace(a,"")),r.test(d)&&(d=d.split(",").join("")),(d!==s||n.test(d))&&(e[h]=n.test(d)?parseFloat(d):d)}else null===s&&(e[h]=0)})}}}}function x(i,r){var n,a,o,s,d=t.defer(),p=window.tubiaoxiuOption.chartedit.echartsMapChart,c=0;if("56"!==i.compId&&-1!==p.indexOf(i.compId)&&r){var l=_.first(i.simpleJson.data["default"]),u=_.rest(i.simpleJson.data["default"]),h=i.simpleJson.data.properties;for(dataPro in h)if(h[dataPro].bind[0]&&h[dataPro].bind[0].areaFlag){c++,n=h[dataPro].bind[0].name,a=l.indexOf(n),o=[],_.each(u,function(e){o.push(e[a])}),s=_.compact(_.uniq(o));var f={method:"POST",url:charts_server+"/service/charting/resource/areaMatch",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"mapData="+s};e(f).then(function(e){if(e.data.error)console.error("areaMatch -- error"),m();else{var t=e.data.object.nameMap,r=i.simpleJson.data["default"];_.map(t,function(e,t){_.each(e,function(i){for(var n=0;n<r.length;n++)if(r[n].includes(i))for(var a=0;a<r[n].length;a++)r[n][a]===e[0]&&(r[n][a]=t)})}),m()}})}var m=_.after(c,function(){d.resolve()})}else d.resolve();return d.promise}function v(e,t){function i(e){for(var t=[],i=0;i<e.length;i++)"[空]"!==h[e[i]]&&e[i]<h.length&&t.push({name:h[e[i]],fieldName:h[e[i]],fieldSetting:{},areaFlag:!1});return t}function r(){for(var e=new Array(h.length),t=0;t<e.length;t++)for(var i in g){for(var r=!1,n=0;n<g[i].bind.length;n++)if(g[i].bind[n].fieldName===h[t]){e[t]=g[i].name,r=!0;break}if(r)break}return e}function n(){for(var e=null,t=null,i=null,r=null,n=1;n<c.length;n++)e=e>c[n][1]||null==e?c[n][1]:e,t=t<c[n][1]||null==t?c[n][1]:t,i=i>c[n][0]||null==i?c[n][0]:i,r=r<c[n][0]||null==r?c[n][0]:r;p.data.gisRange={minlat:e,maxlat:t,minlng:i,maxlng:r}}function a(e){for(var t=e.simpleJson.option.properties.series,i=t.items.anyOf[0].properties.data.items.anyOf.length,r=0,n=0;n<e.userData.length;n++)for(var a=0;a<e.userData[n].length;a++)if(e.userData[n][a]){r++;break}if(r--,r>i)for(var o=r-i;o>0;){var s=angular.copy(_.last(t.items.anyOf[0].properties.data.items.anyOf)),d=angular.copy(_.last(t.items.anyOf[1].properties.data.items.anyOf));t.items.anyOf[0].properties.data.items.anyOf.push(s),t.items.anyOf[1].properties.data.items.anyOf.push(d),o--}else for(var o=i-r;o>0;)t.items.anyOf[0].properties.data.items.anyOf.pop(),t.items.anyOf[1].properties.data.items.anyOf.pop(),o--}function o(e,t){var i=e.simpleJson.option.properties.series,r=i.items.anyOf.length,n=0;if(t){for(var a=[],o=0;o<e.userData.length;o++)!_.contains(a,e.userData[o][1])&&e.userData[o][1]&&a.push(e.userData[o][1]);a=_.rest(a),n=a.length}else n=1;if(n>r)for(var s=n-r;s>0;){var d=angular.copy(_.last(i.items.anyOf));i.items.anyOf.push(d),s--}else for(var s=r-n;s>0;)i.items.anyOf.pop(),s--}function s(e){e[0].areaFlag=!0}function d(e){var t=_.indexOf(c[0],e[0].name),i=_.uniq(_.pluck(_.rest(c),t));e[0].fieldSetting.sortRule=i}var p=e.simpleJson,c=p.data["default"],l=e.compId;if(c&&p.data.properties){for(var u=angular.copy(c[0]),h=[],f=0;f<u.length;f++)u[f]&&h.push(u[f].replace(new RegExp("（","gm"),"(").replace(new RegExp("）","gm"),")"));if(p.option.properties.visualMap){var m=p.option.properties.visualMap;"undefined"==typeof m.items.anyOf[0].properties.inRange&&(m.items.anyOf[0].properties.inRange={name:"选中元素",isShow:!1,type:["Object"],properties:{color:{name:"颜色",isShow:!1,type:["Array"],"default":["#00471D","#026931","#228D47"]}}}),"undefined"==typeof m.items.anyOf[0].properties.outOfRange&&(m.items.anyOf[0].properties.outOfRange={name:"未选中元素",isShow:!1,type:["Object"]}),"73"===l&&delete p.option.properties.visualMap}"1"===l&&"undefined"==typeof p.option.properties.legend&&(p.option.properties.legend={name:"图例",isShow:!0,type:["Object"],properties:{show:{name:"是否显示",isShow:!0,type:["boolean"],descriptionCN:"","default":!0},left:{name:"水平对齐",isShow:!0,type:["button"],items:["center","left","right"],"default":"center"},top:{name:"垂直对齐",isShow:!0,type:["button"],items:["top","middle","bottom"],"default":"bottom"},orient:{name:"排列方式",isShow:!0,type:["button"],items:["horizontal","vertical"],"default":"horizontal"},textStyle:{name:"文本样式",isShow:!1,type:["Object"],properties:{color:{name:"颜色",isShow:!1,type:["Color"],"default":"#333"},fontStyle:{name:"斜体",isShow:!1,type:["button"],items:["normal","italic"],"default":"normal"},fontWeight:{name:"粗体",isShow:!1,type:["button"],items:["normal","bold","bolder","lighter"],"default":"normal"},fontFamily:{name:"字体",isShow:!1,type:["list"],items:["sans-serif","Microsoft YaHei"],"default":"Microsoft YaHei"},fontSize:{name:"字号",isShow:!1,type:["number"],max:50,min:12,"default":12}}},multiColor:{name:"单系列多彩",isShow:!0,type:["boolean"],"default":!0}}}),"34"===l&&"{b}"===p.option.properties.series.items.anyOf[0].properties.edgeLabel.properties.normal.properties.formatter["default"]&&(p.option.properties.series.items.anyOf[0].properties.edgeLabel.properties.normal.properties.formatter["default"]=""),"76"===l&&"堆积柱线图"===p.option.name&&(l=e.compId="999");var g=angular.copy(p.data.properties);switch(l){case"58":g.xAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"8":g.xAxis.bind=i([0]),g.yAxis.bind=i([1]),g.value.bind=i(_.range(2,c[0].length)),_.each(g.value.bind,function(e){e.fieldSetting.aggregation={description:null,formula:"sum",name:"求和",numericOnly:!0}});break;case"0":g.yAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"1":g.yAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"111":g.yAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"2":case"984":g.yAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"3":case"4":case"983":g.xAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"22":case"23":g.xAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"25":g.xAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length,2)),g.valueBar.bind=i(_.range(2,c[0].length,2));break;case"1025":g.xAxis.bind=i([0]),g.valueLeft.bind=i(_.range(1,c[0].length,2)),g.valueRight.bind=i(_.range(2,c[0].length,2));break;case"999":g.xAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length,2)),g.valueBar.bind=i(_.range(2,c[0].length,2));break;case"34":g.category_src.bind=i([0]),g.category_tar.bind=i([1]),g.source.bind=i([0]),g.target.bind=i([1]),g.value.bind=i([2]);break;case"49":g.legend.bind=i(_.range(0,c[0].length-1)),g.value.bind=i([c[0].length-1]);break;case"6":case"47":g.source.bind=i([0]),g.target.bind=i([1]),g.value.bind=i([2]);break;case"51":g.legend.bind=i([0]),g.value.bind=i([1]);break;case"64":g.ID.bind=i([0]),g.node.bind=i([1]),g.value.bind=i([2]),g.parentID.bind=i([3]);break;case"66":g.source.bind=i([0]),g.nodeName.bind=i([1]),g.category.bind=i([2]),g.value.bind=i([3]),g.target.bind=i([4]);break;case"48":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.value.bind=i([2]);break;case"27":g.legend={bind:[],colorType:1,isMore:!1,name:"图例颜色",type:["string"]},g.xAxis.bind=i([0]),g.status.bind=i([1]),g.value.bind=i(_.range(2,c[0].length));break;case"28":g.legend={bind:[],colorType:1,isMore:!1,name:"图例颜色",type:["string"]},g.yAxis.bind=i([0]),g.status.bind=i([1]),g.value.bind=i(_.range(2,c[0].length));break;case"40":g.parallelAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"30":g.xAxis.bind=i([0]),g.open.bind=i([1]),g.close.bind=i([2]),g.lowest.bind=i([3]),g.highest.bind=i([4]);break;case"32":g.line1.bind=i([0]),g.line2.bind=i([1]),g.value1.bind=i([2]),g.value2.bind=i([3]);break;case"50":g.text.bind=i([0]),g.value.bind=i([1]);break;case"60":g.text.bind=i([0]),g.value.bind=i([1]),0!=i([2]).length&&(g.valueLabel.bind=i([2]));break;case"982":g.text.bind=i([0]),g.value.bind=i([1]);break;case"83":if(c){c.reverse();var b=c.pop();c.unshift(b);var x=c.length;if(g.yAxis.bind=new Array(x),g.currentValue.bind=new Array(x),g.intentValue.bind=new Array(x),0!=i([0]).length&&(g.yAxis.bind=i([0])),0!=i([1]).length){for(var v=0;v<c.length;v++)c[v][1]=""==c[v][1]?1:c[v][1];g.intentValue.bind=i([1])}if(0!=i([2]).length){for(var v=0;v<c.length;v++)c[v][2]=""==c[v][2]?1:c[v][2];g.currentValue.bind=i([2])}}break;case"831":if(c){c.reverse();var b=c.pop();c.unshift(b);var x=c.length;if(g.yAxis.bind=new Array(x),g.currentValue.bind=new Array(x),g.intentValue.bind=new Array(x),0!=i([0]).length&&(g.yAxis.bind=i([0])),0!=i([1]).length){for(var v=0;v<c.length;v++)c[v][1]=""==c[v][1]?1:c[v][1];g.intentValue.bind=i([1])}if(0!=i([2]).length){for(var v=0;v<c.length;v++)c[v][2]=""==c[v][2]?1:c[v][2];g.currentValue.bind=i([2])}}break;case"88":g.xAxis.bind=i([0]),g.value.bind=i([1]);break;case"1077":g.leftValue.bind=[],g.value.bind=[],g.rightValue.bind=[];for(var v=0;v<c[0].length&&!(v>=3);v++)if(c[0][v]&&c[1][v]){if(0==g.value.bind.length){g.value.bind=i([v]);continue}if(0==g.leftValue.bind.length){g.leftValue.bind=i([v]);continue}if(0==g.rightValue.bind.length){g.rightValue.bind=i([v]);break}}break;case"35":g.value.bind=i([0]);break;case"63":g.value.bind=i([1]);break;case"68":g.value.bind=i([0]);break;case"11":case"10":case"13":case"14":case"15":case"16":g.xAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"12":g.yAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length))):(g.legend.bind=[],g.value.bind=i([1]));break;case"17":g.xAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"42":case"41":case"411":case"7":g.legend.bind=i([0]),g.value.bind=i([1]);break;case"46":g.legend.bind=i([0]),g.outerSize.bind=i([1]),g.innerSize.bind=i([2]);break;case"70":g.value.bind=i([1]);break;case"31":g.xAxis.bind=i([0]),g.yAxis.bind=i([1]),g.value.bind=i([2]);break;case"52":g.legend.bind=i([0]),g.yAxis.bind=i([1]),g.xAxis.bind=i([2]),g.size.bind=i([3]);break;case"998":g.legend.bind=i([0]),g.yAxis.bind=i([1]),g.xAxis.bind=i([2]),g.size.bind=i([3]);break;case"53":g.xAxis.bind=i([0]),g.yAxis.bind=i([1]),g.size.bind=i([2]);break;case"54":case"55":case"993":g.geo.bind=i([0]),g.size.bind=i([1]),s(g.geo.bind);break;case"56":g.legend.bind=i([0]),g.geo.bind=i([1]),g.size.bind=i([2]),"undefined"!=typeof p.option.properties.series.items.anyOf[0].properties.symbolSize&&delete p.option.properties.series.items.anyOf[0].properties.symbolSize;break;case"57":g.angleAxis.bind=i([0]),g.radiusAxis.bind=i([1]),g.size.bind=i([2]);break;case"39":g.geo.bind=i([0]),g.value.bind=i(_.range(1,c[0].length)),s(g.geo.bind);break;case"992":g.geo.bind=i([0]),g.value.bind=i([1]),i([2]).length>0&&(g.labelStyle.bind=i([2])),s(g.geo.bind);break;case"38":g.source.bind=i([0]),g.target.bind=i([1]),g.value.bind=i([2]),s(g.source.bind),s(g.target.bind);break;case"61":g.longitude.bind=i([0]),g.latitude.bind=i([1]),g.sample.bind=i([2]),n();break;case"62":g.longitude.bind=i([0]),g.latitude.bind=i([1]),g.count.bind=i([2]),n();break;case"67":g.longitude.bind=i([0]),g.latitude.bind=i([1]),g.sample.bind=i([2]),g.details.bind=i([3]),n();break;case"36":g.xAxis.bind=i([0]),g.yAxis.bind=i([1]),g.value.bind=i([2]);break;case"37":g.geo.bind=i([0]),g.value.bind=i([1]),s(g.geo.bind);break;case"59":g.col.bind=i([0]),g.row.bind=i([1]),g.value.bind=i([2]);break;case"45":g.legend.bind=i([0]),g.value.bind=i(_.range(1,c[0].length));break;case"44":g.group.bind=i([0]),g.text.bind=i([1]),g.value.bind=i([2]);break;case"33":g.legend.bind=i([0]),g.value.bind=i([1]);break;case"65":g.legend.bind=i([1]),g.timeField.bind=i([0]),_.each(g.timeField.bind,function(e){e.timeType=!0}),g.value.bind=i([2]);break;case"71":g.longitude.bind=i([1]),g.latitude.bind=i([2]),g.value.bind=i([3]);break;case"72":g.longitude.bind=i([1]),g.latitude.bind=i([2]),g.value.bind=i([3]);break;case"73":g.xAxis3D.bind=i([0]),g.yAxis3D.bind=i([1]),g.value.bind=i([2]);break;case"76":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.value.bind=i([2]);break;case"77":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.value.bind=i([2]);break;case"78":g.kind.bind=i([0]),g.value.bind=i([1]);break;case"81":g.angleAxis.bind=i([0]),g.radiusAxis.bind=i([1]);break;case"997":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.value.bind=i([2]),g.time.bind=i([3]),d(g.time.bind);break;case"996":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.value.bind=i([2]),g.time.bind=i([3]),d(g.time.bind);break;case"995":g.legend.bind=i([0]),g.yAxis.bind=i([1]),g.xAxis.bind=i([2]),g.size.bind=i([3]),g.time.bind=i([4]),d(g.time.bind);break;case"994":g.value.bind=i([0]),g.time.bind=i([1]),d(g.time.bind);break;case"2076":g.map.bind=i([0]),g.value.bind=i([1]),g.geo.bind=i([2]),g.size.bind=i([3]),i([4]).length>0&&(g.labelStyle.bind=i([4])),s(g.map.bind),s(g.geo.bind);break;case"991":g.node.bind=i([0]),g.value.bind=i([1]),g.parentID.bind=i([2]);break;case"990":g.xAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length)),a(e);break;case"985":g.yAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length)),a(e);break;case"989":g.yAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length)),o(e,!0)):(g.legend.bind=[],g.value.bind=i([1]),o(e,!1));break;case"986":g.xAxis.bind=i([0]),c[0].length>=3?(g.legend.bind=i([1]),g.value.bind=i(_.range(2,c[0].length)),o(e,!0)):(g.legend.bind=[],g.value.bind=i([1]),o(e,!1));break;case"988":g.yAxis.bind=i([0]),g.value.bind=i(_.range(1,c[0].length-1)),g.time.bind=i([c[0].length-1]),d(g.time.bind);break;case"987":g.xAxis.bind=i([0]),g.legend.bind=i([1]),g.stack.bind=i([2]),g.value.bind=i([3]);break;case"1078":g.legend.bind=i(_.range(0,c[0].length-1)),g.value.bind=i([c[0].length-1]);break;case"1079":g.legend.bind=i([0]),g.value.bind=i([1]);break;case"1080":g.legend.bind=i(_.range(0,c[0].length-1)),g.value.bind=i([c[0].length-1])}var y=!1;e.tableOptions||(e.tableOptions={});var w=r();return e.tableOptions.bindHint&&w.toString()===e.tableOptions.bindHint.toString()||(y=!0),e.tableOptions.bindHint=w,p.data.properties=g,y}}function y(e){e=angular.copy(e);var t=_.findIndex(e,function(e){return!e[0]&&0!==e[0]});-1!==t&&(e=e.slice(0,t));var i=_.findIndex(e[0],function(e){return!e&&0!==e});return-1!==i&&_.each(e,function(t,r){e[r]=t.slice(0,i)}),e}function w(e,t){if(e=y(e),!t||0==t.length)return e;for(var i=e.slice(1),r={},n=0;n<e[0].length&&e[0][n];n++)r[e[0][n]]=n;for(var n=0;n<t.length;n++)r.hasOwnProperty(t[n].field.name)&&(i=_.filter(i,function(e){return-1!=_.indexOf(t[n].context.routine.matchValues,e[r[t[n].field.name]])})),0==i.length&&(i=e.slice(1));return i.splice(0,0,e[0]),i}function I(e,t){if(e.properties)for(var i in e.properties)e.properties[i]&&(I(e.properties[i],t),"fontSize"===i||"fontsize"===i||"symbolSize"===i||"3dpieradius"===i||"3dpieyHeight"===i||"rightTextLineheight"===i||"symbolSizeMin"===i||"symbolSizeMax"===i?e.properties[i]["default"]=e.properties[i]["default"]*t:"padding"===i?e.properties[i].top&&e.properties[i].bottom&&e.properties[i].left&&e.properties[i].right&&(e.properties[i].top["default"]=e.properties[i].top["default"]*t,e.properties[i].bottom["default"]=e.properties[i].bottom["default"]*t,e.properties[i].left["default"]=e.properties[i].left["default"]*t,e.properties[i].right["default"]=e.properties[i].right["default"]*t):"grid"===i?e.properties[i].properties&&e.properties[i].properties.top&&e.properties[i].properties.bottom&&e.properties[i].properties.left&&e.properties[i].properties.right&&(e.properties[i].properties.top["default"]=e.properties[i].properties.top["default"]*t,e.properties[i].properties.bottom["default"]=e.properties[i].properties.bottom["default"]*t,e.properties[i].properties.left["default"]=e.properties[i].properties.left["default"]*t,e.properties[i].properties.right["default"]=e.properties[i].properties.right["default"]*t):"width"===i&&"线宽"===e.properties[i].name?e.properties[i].max?e.properties[i]["default"]=Math.min(e.properties[i]["default"]*t,e.properties[i].max):e.properties[i]["default"]=e.properties[i]["default"]*t:"borderWidth"===i&&"描边线宽"===e.properties[i].name?e.properties[i].max?e.properties[i]["default"]=Math.min(e.properties[i]["default"]*t,e.properties[i].max):e.properties[i]["default"]=e.properties[i]["default"]*t:"itemWidth"===i&&"图例标记宽度"===e.properties[i].name?e.properties[i].max?e.properties[i]["default"]=Math.min(e.properties[i]["default"]*t,e.properties[i].max):e.properties[i]["default"]=e.properties[i]["default"]*t:"itemHeight"===i&&"图例标记高度"===e.properties[i].name&&(e.properties[i].max?e.properties[i]["default"]=Math.min(e.properties[i]["default"]*t,e.properties[i].max):e.properties[i]["default"]=e.properties[i]["default"]*t));else{if(!e.items||!e.items.anyOf)return;_.each(e.items.anyOf,function(i,r){for(var n in e.items.anyOf[r].properties)I(e.items.anyOf[r].properties[n],t),"fontSize"===n||"fontsize"===n||"symbolSize"===n||"3dpieradius"===n||"3dpieyHeight"===n?e.items.anyOf[r].properties[n]["default"]=e.items.anyOf[r].properties[n]["default"]*t:"padding"===n?e.items.anyOf[r].properties[n].properties&&(e.items.anyOf[r].properties[n].properties.top["default"]=e.items.anyOf[r].properties[n].properties.top["default"]*t,e.items.anyOf[r].properties[n].properties.bottom["default"]=e.items.anyOf[r].properties[n].properties.bottom["default"]*t,e.items.anyOf[r].properties[n].properties.left["default"]=e.items.anyOf[r].properties[n].properties.left["default"]*t,e.items.anyOf[r].properties[n].properties.right["default"]=e.items.anyOf[r].properties[n].properties.right["default"]*t):"grid"===n&&e.properties[n].properties&&e.properties[n].properties.top&&e.properties[n].properties.bottom&&e.properties[n].properties.left&&e.properties[n].properties.right&&(e.properties[n].properties.top["default"]=e.properties[n].properties.top["default"]*t,e.properties[n].properties.bottom["default"]=e.properties[n].properties.bottom["default"]*t,e.properties[n].properties.left["default"]=e.properties[n].properties.left["default"]*t,e.properties[n].properties.right["default"]=e.properties[n].properties.right["default"]*t)})}}var k={chartbookId:"",dataSetBindings:[]},C={};return{dispose:r,getBindData:n,getDrillThroughData:o,registerDataSetBindings:s,checkDataSetBindings:d,getInteractiveStatus:c,setInteractiveStatus:l,cancelInteractiveStatus:u,metaJsonToSimpleJson:h,simpleJsonToMetaJson:m,bindFieldsWithUserData:v,washUserData:b,areaMatch:x,updateJsonDataDefaultWithUserData:y,calcConditionedData:w,convertFontSize:I}}]).controller("chartCtrl",["$scope","chartService","$modal",function(e,t,i){function r(e){e&&(e=angular.extend({},e),angular.extend(w,e))}function n(e,t){var i=t.find(".chart");if(0===i.length){var r=document.createElement("div");r.style.width="100%",r.style.height="100%",r.setAttribute("class","chart chartshowid"),e.dom=r,t.append(r);var n=document.createElement("div");n.style.position="absolute",t.append(n)}else e.dom=i[0];return e}function a(e){return e.id||(e.id=UUID.prototype.createUUID("")),e}function o(e,t){_.each(t,function(t){if(t.fieldSetting&&t.fieldSetting.decimal)for(var i=_.indexOf(e[0],t.name),r=parseInt(t.fieldSetting.decimal.value),n=1,a=e.length;a>n;n++)e[n][i]=e[n][i].toFixed(r)})}function s(e,t){return datavizCharts.initInstance(e,t)}function d(){return"8"===e.chartObj.compId||"58"===e.chartObj.compId}function p(e,require){var t=!1;if(!e||!require)return!1;var i=e.data.properties,r={string:0,map:0,time:0,number:0};for(var n in i)switch(i[n].type[0]){case"string":r.string+=i[n].bind.length;break;case"map":r.map+=i[n].bind.length;break;case"time":r.time+=i[n].bind.length;break;case"number":r.number+=i[n].bind.length}for(var n in require)"n"==require[n]?require[n]=1:"m"==require[n]&&(require[n]=2);return t=r.string>=require.string&&r.number>=require.number&&r.map>=require.map&&r.time>=require.time,t?!0:{string:require.string-r.string,number:require.number-r.number,map:require.map-r.map,time:require.time-r.time}}function c(require){var e=[];for(var t in require)require[t]>0&&e.push("拖拽"+require[t]+"个"+C[t]);return e}function l(e){var t=[];for(var i in e)t.push(e[i].bind);return _.flatten(t)}function u(e){var t=[];for(var i in e)"number"!==e[i].type[0]&&(t=t.concat(e[i].bind));return t}function h(e){return datavizCharts.getInstanceByDom(e)}function f(e,t,i,r){var n=u(e),a=[],o="interactive";return _.each(n,function(e){a.push(m(e.fieldName,t[e.name],i,e.timeKey,r,o))}),a}function m(e,t,i,r,n,a){var o={isTemp:!0,trigger:{chartId:n,type:a},context:{routine:{active:!0,matchValues:[],others:!1},wildcard:{active:!1,matchType:"isEmpty",matchValue:"",others:!1}},field:{dataSetId:i,name:e,timeKey:r,role:"string",type:"string"}};return o.context.routine.matchValues.push(x(t+"",r)),o}function g(r,n,a,o,s){var d,p,c,l,h,f,g,b,x=[],s=s;if(_.each(n,function(e,t){e.hierarchy&&(l=t,f=e.hierarchyIndex,f>=1&&(p=e.hierarchy[f-1].name),f<e.hierarchy.length-1&&(d=e.hierarchy[f+1].name))}),d){var h="下钻至"+d,v="drillDown",y=function(t){if(g=n[l].fieldName,b=n[l].name,n[l].timeKey){var i,r,p=n[l].timeHierarchyType,c=n[l].timeType,u=n[l].hierarchyIndex,h=n[l].hierarchy,f=n[l].timeKey;i=p===k[0].name?"prefix":"noPrefix",r=_.indexOf(I[i][c].all,h[u+1].name),n[l].timeKey=I[i][c].key[r]}else n[l].fieldName=d;n[l].hierarchyIndex++,a.push(m(g,t[b],o,f,s,v)),e.$broadcast("dataviz-chart-render",{updateData:!0})};r.setContextMenu(h,y)}if(p){var w="上卷至"+p,v="rollUp",C=function(t){if(n[l].timeKey){var i,r,o=n[l].timeHierarchyType,s=n[l].hierarchy,d=n[l].timeType,c=n[l].hierarchyIndex;i=o===k[0].name?"prefix":"noPrefix",r=_.indexOf(I[i][d].all,s[c-1].name),n[l].timeKey=I[i][d].key[r]}else n[l].fieldName=p;n[l].hierarchyIndex--,a.pop(),e.$broadcast("dataviz-chart-render",{updateData:!0})};r.setContextMenu(w,C)}c="详细信息",x=u(r.option.data.properties);var O=function(e){var r=angular.copy(a),n="drillThrough";_.each(x,function(t){r.push(m(t.fieldName,e[t.name],o,t.timeKey,s,n))}),t.getDrillThroughData(o,r).then(function(e){i.open({controller:"drillThroughCtrl",templateUrl:"modules/chartedit/chart/drillThrough.html",backdrop:!0,size:"lg",resolve:{data:function(){return e}}})})};r.setContextMenu(c,O)}function b(e,t){for(var i,r,n,a,o,s=0,d=e[0].length;d>s;s++)for(var p=0,c=t.length;c>p;p++)if(e[0][s]===t[p].name&&t[p].timeKey){i=s,r=t[p].hierarchy[t[p].hierarchyIndex].name,n=t[p].timeKey;break}if(n){switch(n){case"Y-Q":a=/(\d{1,4}) (\d{1})/,o="$1年$2季度";break;case"Y-M":a=/(\d{1,4})-(\d{1,2})/,o="$1年$2月";break;case"Y-W":a=/(\d{1,4}) (\d{1,2})/,o="$1年第$2周";break;case"Y-M-D":a=/(\d{1,4})-(\d{1,2})-(\d{1,2})/,o="$1年$2月$3日";break;case"h:m":a=/(\d{1,2}):(\d{1,2})/,o="$1时:$2分";break;case"h:m:s":a=/(\d{1,2}):(\d{1,2}):(\d{1,2})/,o="$1时:$2分:$3秒";break;case"Y-M-D h:m:s":a=/(\d{1,4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})/,o="$1年$2月$3日$4时:$5分:$6秒";break;default:a=/$/,o=r}for(var s=1,d=e.length;d>s;s++)e[s][i]=e[s][i].replace(a,o);return e}}function x(e,t){var i,r;if(!t)return e;switch(t){case"Y-Q":i=/(\d{1,4})年(\d{1})季度/,r="$1 $2";break;case"Y-M":i=/(\d{1,4})年(\d{1,2})月/,r="$1-$2";break;case"Y-W":i=/(\d{1,4})年第(\d{1,2})周/,r="$1 $2";break;case"Y-M-D":i=/(\d{1,4})年(\d{1,2})月(\d{1,2})日/,r="$1-$2-$3";break;case"h:m":i=/(\d{1,2})时:(\d{1,2})分/,r="$1:$2";break;case"h:m:s":i=/(\d{1,2})时:(\d{1,2})分:(\d{1,2})秒/,r="$1:$2:$3";break;case"Y-M-D h:m:s":i=/(\d{1,4})年(\d{1,2})月(\d{1,2})日(\d{1,2})时:(\d{1,2})分:(\d{1,2})秒/,r="$1-$2-$3 $4:$5:$6";break;default:i=/\D+/,r=""}return e.replace(i,r)}function v(e){return _.each(e,function(e){_.each(e,function(e){return null===e?!1:void 0})}),!0}function y(){return"58"===e.chartObj.compId}var w=this,I={prefix:{dateModel:{all:["年","年-季度","年-月","年-周","年-月-日"],key:["Y","Y-Q","Y-M","Y-W","Y-M-D"],
init:[0,2,5]},timeModel:{all:["时","时:分","时:分:秒"],key:["h","h:m","h:m:s"],init:[0,1]},datetimeModel:{all:["年","年-季度","年-月","年-周","年-月-日","时","时:分","时:分:秒","年-月-日 时:分:秒"],key:["Y","Y-Q","Y-M","Y-W","Y-M-D","h","h:m","h:m:s","Y-M-D h:m:s"],init:[0,2,5]}},noPrefix:{dateModel:{all:["年","季度","月","周","日"],key:["Y","Q","M","W","D"],init:[0,2,5]},timeModel:{all:["时","分","秒"],key:["h","m","s"],init:[0,1]},datetimeModel:{all:["年","季度","月","周","日","时","分","秒"],key:["Y","Q","M","W","D","h","m","s"],init:[0,2,5]}}},k=[{name:"带前缀",prefix:!0},{name:"不带前缀",prefix:!1}],C={string:"维度（字符）",number:"度量（数值）",time:"维度（时间）",map:"维度（地理位置）"};w.setOptions=r,w.setDom=n,w.setId=a,w.setDecimals=o,w.initInstance=s,w.readyToRender=p,w.generateRequireStr=c,w.getBindFields=l,w.getInstanceByDom=h,w.setDrill=g,w.generateTempCond=f,w.formatTimeData=b,w.verifyData=v,w.isLazyLoad=y,w.isTableChart=d}]).controller("drillThroughCtrl",["$scope","data","$modalInstance",function(e,t,i){var r,n,a=10,o=5;e.currentPage=1,e.currentPagination=0,e.header=t.shift(),r=t.length/a,e.listLength=t.length,r>Math.floor(r)?e.pageLength=Math.floor(r)+1:e.pageLength=r,n=e.pageLength/o,n=n>Math.floor(n)?Math.floor(n)+1:n,e.data=t.slice(0,a),e.currentPagination*o+o+1>e.pageLength?e.pageNumber=_.range(e.currentPagination*o+1,e.pageLength+1):e.pageNumber=_.range(e.currentPagination*o+1,e.currentPagination*o+o+1),e.index=0,e.selectPage=function(i){e.currentPage=e.currentPagination*o+i+1,e.data=t.slice((e.currentPage-1)*a,e.currentPage*a),e.index=i},e.leftPage=function(i){0!==e.currentPagination&&(e.currentPagination--,e.currentPage=e.index+e.currentPagination*o+1,e.data=t.slice((e.currentPage-1)*a,e.currentPage*a),e.pageNumber=_.range(e.currentPagination*o+1,e.currentPagination*o+o+1))},e.rightPage=function(){e.currentPagination!==n-1&&(e.currentPagination++,e.currentPage=e.index+e.currentPagination*o+1,e.currentPage>e.pageLength&&(e.currentPage=e.pageLength,e.index=e.currentPage-e.currentPagination*o-1),e.currentPagination*o+o+1>e.pageLength?e.pageNumber=_.range(e.currentPagination*o+1,e.pageLength+1):e.pageNumber=_.range(e.currentPagination*o+1,e.currentPagination*o+o+1),e.data=t.slice((e.currentPage-1)*a,e.currentPage*a))},e.dismiss=function(){i.close(!1)}}]).controller("addComponentsCtrl",["$scope","$rootScope","$modalInstance","$http","toaster","widget",function(e,t,i,r,n,a){e.form={},e.iconCountLimit=t.userinfo.limit.iconcount,r.get("assets/icon/icons.json").then(function(t){e.icons=t.data,"img"===a.type?e.form.componentType="img":"icon"===a.type?(e.form.componentType="icon",e.form.setIconColor=a.resource.setIconContent,e.form.iconContent=a.resource.iconContent,e.colorPicker={"background-color":a.resource.setIconContent},e.iconColor={color:a.resource.setIconContent},e.lastIconIndex=e.icons.indexOf(e.form.iconContent)):(e.lastIconIndex=0,e.form.componentType="icon",e.form.setIconColor="rgb(102, 102, 102)",e.form.iconContent=e.icons[e.lastIconIndex],e.colorPicker={"background-color":e.form.setIconColor},e.iconColor={color:e.form.setIconColor})}),e.chooseIcon=function(t){var i=$(".modal-icons-components");t!==e.lastIconIndex?(i[e.lastIconIndex].classList.remove("modal-icons-components-active"),i[t].classList.add("modal-icons-components-active"),e.lastIconIndex=t,e.form.iconContent=e.icons[e.lastIconIndex]):(i[t].classList.add("modal-icons-components-active"),e.form.iconContent=e.icons[e.lastIconIndex])},e.$on("iconColorChange",function(t,i){e.form.setIconColor=i,e.$apply(function(){e.colorPicker={"background-color":i},e.iconColor={color:i}})}),e.$watch("form.img",function(){"img"===e.form.componentType&&e.form.img&&e.submit()}),e.submit=function(){"icon"===e.form.componentType&&-1!==e.iconCountLimit&&e.lastIconIndex>e.iconCountLimit?n.pop("info","","该图标为银会员所有"):i.close(e.form)},e.dismiss=function(){i.dismiss()}}]).directive("datavizChart",["chartService","$rootScope","$stateParams","$timeout","themeService","toaster","$q",function(e,t,i,r,n,a,o){return{restrict:"A",transclude:!0,scope:{config:"=",chartObj:"=",themeId:"=",widget:"=",mode:"=",largeTextRatio:"="},template:'<div class="pos-rlt w-full h-full" ng-hide="hideSketch" style="position: absolute;"><div ng-if="showError" class="text-center chart-error-message" style="color: #aaaaaa; font-size: 18px;position: absolute;width: 100%;left: 50%;top: 50%;transform: translate(-50%, -50%);">图表：{{errorChartName}}<br>未能成功渲染，请检查数据格式是否正确</div></div>',controller:"chartCtrl",link:function(i,a,s,d){function p(r){r.on("click",function(n,a){if(i.widget&&i.widget.props&&i.widget.props.asFilter){var o=i.widget.props;if(o.asFilter){var s=d.generateTempCond(i.chartObj.simpleJson.data.properties,a,"0",i.chartObj.id),p=r.interactive.highlight?"interaction-trigger-emit":"interaction-recover-emit";r.interactive.highlight?e.setInteractiveStatus(i.chartObj.id,a):e.setInteractiveStatus(i.chartObj.id,a),t.$broadcast(p,{tempConditions:s,chartId:i.chartObj.id,type:"interactive"})}}})}i.hideSketch=!1,i.chartRequire,i.isFirstRender=!0;var c,l,u,h,f,m,g={getGroupCounts:function(e){var t=o.defer(),r=[],n=[];return r.push(_.rest(i.chartObj.userData).length),n.push(r),t.resolve(n),t.promise},getGroupData:function(t,r){var n=o.defer(),a=e.getGroupData(i.chart.dataset.id,bindFields,h,i.chart.simpleJson.data.rawConditions,dataSetBindings,t,i.chart.id,r);return a.then(function(e){1!=e.length||r?i.chart.simpleJson.dom&&(i.chart.simpleJson.dom.style.display=null):(remindNoData(),i.chart.simpleJson.dom&&(i.chart.simpleJson.dom.style.display="none")),sortService.sort(i.chart.dataset.id,bindFields,h,dataSetBindings,e,i.chart.id).then(function(e){var t=checkData(e,bindFields,i.chart.compId);n.resolve({data:transformData(t,c.option.data.properties)})})},function(){remindDataFailed(),n.reject()}),n.promise},getPageData:function(e,t,r){var n=o.defer(),a={};return a.data=angular.copy(i.chartObj.userData),n.resolve(a),n.promise},getTotal:function(e,t){var i=o.defer(),r=_.map(_.initial(e[0]),function(){return 0});return _.each(_.rest(e),function(e){_.map(_.rest(e),function(e,t){r[t]=e+r[t]})}),i.resolve(r),i.promise},getBindData:function(e){var t=o.defer(),r={};return r.data=angular.copy(i.chartObj.userData),t.resolve(r),t.promise}},b={getGroupData:function(t,r){var n=o.defer(),a=e.getGroupData(i.chart.dataset.id,t,h,i.chart.simpleJson.data.rawConditions,dataSetBindings,null,i.chart.id,r);return a.then(function(e){var r=checkData(e,t,i.chart.compId);n.resolve({data:transformData(r,c.option.data.properties)})},function(){remindDataFailed(),n.reject()}),n.promise}};d.setOptions(i.config),i.tempChartObjHandle=function(t){if("undefined"!=typeof i.largeTextRatio&&1!==parseFloat(i.largeTextRatio)&&e.convertFontSize(t.simpleJson.option,i.largeTextRatio),t.simpleJson.option.properties&&(t.simpleJson.option=e.metaJsonToSimpleJson(t.simpleJson.option.properties)),"exportChart"===i.mode&&"undefined"!=typeof t.simpleJson.option.timeline&&(t.simpleJson.option.timeline.autoPlay=!1),"exportChart"!==i.mode&&"playChart"!==i.mode||"71"===t.compId&&(t.simpleJson.option.globe.environment="./src/assets/chart/resource/data-universal.jpg",t.simpleJson.option.globe.baseTexture="./src/assets/chart/resource/data-globe.jpg",t.simpleJson.option.globe.heightTexture="./src/assets/chart/resource/data-globe.jpg"),"58"===i.chartObj.compId){datavizCharts.registerAsyncDataLoad({type:"datalist",compIds:["58"],use:g});var r=null,n=!0;t.simpleJson.option.extraInfo={updateData:n,needSort:r}}else if("8"===i.chartObj.compId){datavizCharts.registerAsyncDataLoad({type:"pivot",compIds:["8"],use:b});var n=!0;t.simpleJson.option.extraInfo={updateData:n}}t.simpleJson=d.setDom(t.simpleJson,a),t.simpleJson.option.compId=t.compId},i.drawChart=_.debounce(function(o,s,m){if(i.showError=!1,i.errorChartName="",i.themeId){if(u=i.themeId,s=s||"undefined"!=typeof i.widget&&i.widget.themeChanged,h=i.chartObj.simpleJson.data.conditions,i.chartObj.userData){var g=!1;if(0===i.chartObj.simpleJson.data["default"].length||i.chartObj.dataQuery)i.chartObj.simpleJson.data["default"]=angular.copy(i.chartObj.userData),g=!0;else if(m){if(m.toString()===i.chartObj.simpleJson.data["default"].toString())return;i.chartObj.simpleJson.data["default"]=m,g=!0}else("83"===i.chartObj.compId||"831"===i.chartObj.compId)&&i.chartObj.userData.length>1&&(i.chartObj.simpleJson.data["default"]=angular.copy(i.chartObj.userData));e.bindFieldsWithUserData(i.chartObj,g),e.washUserData(i.chartObj),e.areaMatch(i.chartObj,o).then(function(){l=angular.copy(i.chartObj),i.tempChartObjHandle(l),n.registerThemeToChart(u,l,!s),i.widget&&i.widget.themeChanged&&delete i.widget.themeChanged,c&&!c._isDisposed||(c=d.initInstance(l.simpleJson.dom,u));var o=angular.copy(l.simpleJson.option),h=angular.copy(l.simpleJson.data);if(c.setOptionAndData(o,h,l.compId,s&&u),s){var m=n.getThemeById(u);c.setChartJsonColor(m.define,l.simpleJson.option),c.themeChanged=!0}else c.themeChanged=!1;p(c);try{c.render(!1,function(){i.chartObj.isRenderError=!1,i.$emit("chartRenderDone")})}catch(g){throw r(function(){i.errorChartName=i.chartObj.simpleJson.option.properties.title?i.chartObj.simpleJson.option.properties.title.properties.text["default"]:i.chartObj.name,i.showError=!0,i.chartObj.isRenderError=!0,c.dispose()},0),g}finally{!i.chartObj.id&&(i.chartObj.id=UUID.prototype.createUUID("")),$(a).addClass("CHARTID_"+i.chartObj.id),s&&(t.$broadcast("setPropertyWatchRevoke"),i.chartObj.simpleJson.option.properties=e.simpleJsonToMetaJson(l.simpleJson.option,i.chartObj.simpleJson.option)),f=e.getInteractiveStatus(i.chartObj.id),f&&c.highlight(f),i.isFirstRender=!1}})}i.$$phase||i.$digest()}},100),i.dispose=function(){if(i.chartObj.simpleJson.dom&&""!==i.chartObj.simpleJson.dom&&(c=d.getInstance(i.chartObj.simpleJson),c.instance)){c.dispose();for(var e in i.chartObj.simpleJson.data.properties)i.chartObj.simpleJson.data.properties[e].bind=[]}};var x=i.$on("drawChart",function(e,t){var r=!1,n=!1;t&&(r=t.isAreaMatch?t.isAreaMatch:!1,n=t.isThemeChanged?t.isThemeChanged:!1),i.drawChart(r,n)}),v=i.$on("interaction-trigger-broadcast",function(t,r){if(i.widget&&i.widget.props&&!i.widget.props.notAccept&&i.chartObj.id!==r.chartId){var n=e.calcConditionedData(i.chartObj.userData,r.tempConditions);i.drawChart(!0,!1,n)}}),y=i.$on("interaction-recover-broadcast",function(e,t){i.widget&&i.widget.props&&!i.widget.props.notAccept&&i.chartObj.id!==t.chartId&&i.drawChart(!0,!1,_.filter(i.chartObj.userData,function(e){return!!e[0]}))}),w=i.$on("drawChartExport",function(e,t){"chartExportDiv"===a[0].getAttribute("id")&&i.drawChart(!0,!1)}),I=i.$on("recoverJsonDataToUserData",function(t,r){i.chartObj.simpleJson.data["default"]=e.updateJsonDataDefaultWithUserData(i.chartObj.userData),r&&i.drawChart(!0,!1)});i.$on("$destroy",function(){c&&(c.dispose(),a.off("click")),x(),v(),y(),w(),I(),clearInterval(m)}),i.$emit("chartReadyToRender"),i.resizeChart=_.debounce(function(){if(!_.isEmpty(i.chartObj)&&!_.isEmpty(i.chartObj.simpleJson)&&c&&c.dom&&c.dom.nodeName)try{c.resize()}catch(e){console.error(e)}}),a.resize(i.resizeChart)}}}]).directive("widgetItemV2",["$rootScope","$modal","$state","$timeout","$sessionStorage","$sce","$compile","$http","Upload","chartLibraryManager","toaster","StatisticsService","vipService","chartExportService","UndoService","chartInstanceInfoManager","MEDIA_TYPES",function(e,t,i,r,n,a,o,s,d,p,c,l,u,h,f,m,g){return{restrict:"AE",replace:!0,scope:{widget:"=",widgetIndex:"=",pageIndex:"=",isLastWidget:"=",bookId:"=",bookName:"=",curTheme:"=",textColor:"=",isNavi:"@",compatVersion:"=",chartInstancesInfo:"="},templateUrl:"tpl/charting/widgetItem_v2.html",link:function(o,s,d){function u(e){return e=angular.copy(e),"chart"===e.type&&(e.resource.id=UUID.prototype.createUUID("")),e.define=o.widget.define,e.props=o.widget.props,e}o.ciCustomEvent=l.ciCustomEvent,o.undoManager=f.getManager("bookEdit"),o.isNavi||(o.isSelectChart=o.chartInstancesInfo.length>0),_browserDetect.ie<10&&(o.isIE9=!0),s.bind("dblclick",function(){if(!o.isNavi)switch(o.widget.type){case"chart":o.editChart();break;case"text":o.editText();break;case"icon":o.editIcon()}}),o.chartGifSupport=!1,o.$on("chartRenderDone",function(){if("chart"===o.widget.type){var e=$(".CHARTID_"+o.widget.resource.id+" .chartshowid");o.chartGifSupport=datavizCharts.getInstanceByDom(e[0]).instance.exportToGif}}),o.$on("chartInstanceQueryDone",function(){o.isNavi||r(function(){o.isSelectChart=o.chartInstancesInfo.length>0})}),o.trustAsHtml=a.trustAsHtml,o.addText=function(){o.oldWidget=angular.copy(o.widget),o.firstAddText=!0,o.widget.type="text",o.widget.resource={},o.widget.resource.content="",o.isSavedToServer=!1,o.editText()},o.editText=function(){o.editorFlag=!0,o.textFlag=!1},o.$on("textEditDone",function(e){e.stopPropagation&&e.stopPropagation(),r(function(){o.editorFlag=!1,o.textFlag=!0,o.$emit("updateWidget",{pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,widget:angular.copy(o.widget),oldWidget:angular.copy(o.oldWidget)})},0)}),o.$on("textEditStart",function(e){e.stopPropagation&&e.stopPropagation(),r(function(){o.editorFlag=!0,o.textFlag=!1,o.firstAddText?o.firstAddText=!1:o.oldWidget=angular.copy(o.widget),setTimeout(function(){var e=document.querySelector(".cke"),t=document.querySelector(".cke").style.top;o.style=document.createElement("style"),o.style.innerText="#"+e.id+"{top: "+t+" !important}",document.head.appendChild(o.style)})},0)}),o.addChart=function(){e.isSavedToServer=!1,i.go("app.chart_instance_dashboard",{chartBookId:o.bookId,pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,curTheme:o.curTheme,actionType:"selectChart"})},o.addExistChart=function(){m.query().then(function(e){o.chartInstancesInfo=e,t.open({templateUrl:"tpl/charting/select_exist_chart.html",controller:"selectExistChartCtrl",size:"lg",scope:o})})},o.editChart=function(){p.getById(o.widget.resource.compId,o.compatVersion).then(function(r){return!r.onSale||r.chartOwning&&!r.chartOwning.isExpired?(e.isSavedToServer=!1,void i.go("app.chart_instance_dashboard",{chartBookId:o.bookId,pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,curTheme:o.curTheme,actionType:"selectChart"})):void t.open({templateUrl:"tpl/security/product_warning_modal.html",controller:"productExpiredWarningModalCtrl",size:"sm",resolve:{params:function(){return angular.copy({msgs:r.chartOwning?["该图表已过期"]:["该图表为高级图表，请前往商城购买以使用"],submitText:r.chartOwning?"去续期":"去购买",url:mall_server+(r.productUrl?r.productUrl:"")})}}})})},o.exportChart=function(){h.exportChart(o.widget.resource)},o.exportChartPng=function(){h.exportChartPng(o.widget.resource)},o.exportChartGif=function(){h.exportChartGif(o.widget.resource)},o.addImageOrIcon=function(){t.open({templateUrl:"tpl/charting/media_library.html",controller:"MediaLibraryCtrl",backdrop:"static",windowClass:"media-lib",resolve:{types:function(){return angular.copy([g.IMAGE,g.ICON])},musicMediaSaved:function(){return null}}}).result.then(function(t){o.oldWidget=angular.copy(o.widget);var i=angular.copy(o.widget);t.type===g.IMAGE?(i.type="image",i.resource={},i.resource.imageStore=t.path):t.type===g.ICON&&(i.type="icon",i.resource={},i.resource.iconContent=t.iconContent,i.resource.setIconContent=t.setIconColor,i.resource.iconFontSize=s.children().last().width()>s.children().last().height()?s.children().last().height():s.children().last().width()),e.isSavedToServer=!1,o.$emit("updateWidget",{pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,widget:i,oldWidget:angular.copy(o.oldWidget)})})},o.copyWidget=function(){o.widget.type&&(n.widget={type:o.widget.type,resource:o.widget.resource,props:o.widget.props,compatVersion:o.compatVersion},c.pop("success","","内容已复制，按下Ctrl+V粘贴。"))},o.pasteWidget=function(){if(n.widget){if("chart"===n.widget.type&&n.widget.compatVersion!==o.compatVersion)return void c.pop("info","","图册版本不兼容，不能粘贴图表");if(o.widget.type){var e=t.open({templateUrl:"tpl/charting/operationConfirm.html",size:"sm",controller:["$scope","$modalInstance",function(e,t){e.message="要替换当前内容吗？",e.dismiss=function(){t.dismiss()},e.submit=function(){t.close()}}]});e.result.then(function(){o.$emit("updateWidget",{pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,widget:u(n.widget)})})}else o.$emit("updateWidget",{pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,widget:u(n.widget)})}},o.clearWidget=function(){o.$emit("updateWidget",{pageIndex:o.pageIndex,widgetIndex:o.widgetIndex,widget:{type:null,resource:{},props:{asFilter:!1,notAccept:!1},define:o.widget.define}})},o.removeWidget=function(){o.$emit("removeWidget",o.widgetIndex)},o.$on("gridster-item-resized-end",function(){"icon"!==o.widget.type||o.isNavi||(o.widget.resource.iconFontSize=s.children().last().width()>s.children().last().height()?s.children().last().height():s.children().last().width())}),o.$on("iconColorChange",function(e,t){o.isNavi||_.isEmpty(o.widget.resource)||"icon"!=o.widget.type||(o.widget.resource.setIconContent=t)}),o.$watch("widget.type",function(e,t){"chart"===e&&r(function(){o.$broadcast("drawChart")})});var b=o.$on("gridster-item-resized",_.debounce(function(t,i){o.hasInited&&(e.isSavedToServer=!1)},100));o.$on("$destroy",function(){b()})}}}]).directive("chartInteraction",["userDataService",function(e){return{restrict:"AE",scope:{widgetIndex:"=",widget:"="},templateUrl:"tpl/charting/interaction_v2.html",link:function(e,t,i){}}}]).directive("helpNavigation",["$rootScope","$state",function(e,t){return{restrict:"AE",scope:!0,templateUrl:"tpl/charting/helpNavigation.html",link:function(i,r,n){i.step=n.step,i.$watch("step",function(e,t){i.switchStep(e)}),i.switchStep=function(t){switch(t){case"first":i.helpBoxClass="first",i.textBox={top:"50px"},i.helpText="点击新建图册，开启图表秀之旅",i.helpEnd=e.isEverLogin?i.closeHelp:i.createChartbook,i.prevText={display:"none"},i.endText=e.isEverLogin?"我知道啦":"下一步";break;case"firstChart":i.helpBoxClass="firstChart",i.textBox={left:"50px"},i.helpText="点击新建图表，创建独有的酷炫图表",i.helpEnd=e.isEverLogin?i.closeHelp:i.createChartInstance,i.prevText={display:"none"},i.endText=e.isEverLogin?"我知道啦":"下一步";break;case"second":i.helpBoxClass="second",i.textBox={top:"50px"},i.helpText="制作的图册可以导出和分享哦~",i.helpEnd=function(){i.step="three"},i.endText="下一步",i.prevText={display:"none"};break;case"three":i.helpBoxClass="three",i.textBox={left:"50px"},i.helpText="点击加号可以添加图册页~",i.helpEnd=i.closeHelp,i.prevText={color:"#07bf84"},i.helpPrev=function(){i.step="second"},i.endText="我知道啦";break;case"forth":localStorage.setItem("showChartInstanceHelp",!0),i.accordionGroupType.open=!0,i.accordionGroupOption.open=!1,i.helpBoxClass="forth",i.textBox={right:"310px"},i.helpText="选择图表（80+种图表任意选择）",i.helpEnd=function(){i.step="fifth"},i.prevText={display:"none"},i.endText="下一步",setTimeout(function(){r.children().attr("style","")});break;case"fifth":i.helpBoxClass="fifth",i.textBox={right:"310px"},i.helpText="点击编辑图表数据",i.helpEnd=function(){i.step="chartSixth",i.changeAccordion(),$("help-navigation").hide()},i.helpPrev=function(){i.step="forth"},i.prevText={color:"#07bf84"},i.endText="下一步",setTimeout(function(){r.children().attr("style",""),r.children().css("left",$("#edit-data-button").position().left),$("help-navigation").show()});break;case"chartSixth":i.helpBoxClass="sixth",i.textBox={right:"310px"},i.helpText="手动输入或上传数据文件",i.helpEnd=function(){i.step="chartSeventh"},i.helpPrev=function(){$("help-navigation").hide(),i.step="fifth",i.changeAccordion()},i.prevText={color:"#07bf84"},i.endText="下一步",setTimeout(function(){r.children().attr("style",""),$("help-navigation").show()});break;case"chartSeventh":i.helpBoxClass="fifth",i.textBox={right:"310px"},i.helpText="点击修改图表属性",i.helpEnd=function(){i.step="sixth",$("help-navigation").hide(),i.changeAccordion()},i.helpPrev=function(){i.step="chartSixth",i.changeAccordion()},i.prevText={color:"#07bf84"},i.endText="下一步",setTimeout(function(){r.children().attr("style",""),r.children().css("left",$("#edit-data-button").position().left)});break;case"sixth":i.accordionGroupType.open=!1,i.accordionGroupOption.open=!0,i.helpBoxClass="sixth",i.textBox={right:"310px"},i.helpText="修改图表属性，给你的图表化化妆",i.helpEnd=function(){i.step="seventh"},i.helpPrev=function(){i.step="fifth"},i.prevText={color:"#07bf84"},i.endText="下一步",setTimeout(function(){r.children().attr("style",""),$("help-navigation").show()});break;case"seventh":i.helpBoxClass="seventh",i.textBox={bottom:"100px"},i.helpText=i.isSelectChart?"点击确定返回图册编辑页面":"点击保存，完成图表制作",i.helpEnd=e.isEverLogin?i.closeHelp:i.isSelectChart?i.confirmChart:i.closeHelp,i.prevText={color:"#07bf84"},i.helpPrev=function(){i.step="sixth"},i.endText=e.isEverLogin?"我知道啦":i.isSelectChart?"下一步":"我知道啦",setTimeout(function(){r.children().css("left",$(".chart-edit-bottom").width()/2-88)});break;case"eighth":i.helpBoxClass="eighth",i.textBox={bottom:"100px"},i.helpText="点击确定把图表插入图册",i.helpEnd=e.isEverLogin?i.closeHelp:i.confirm,i.prevText={color:"#07bf84"},i.helpPrev=function(){i.step="seventh"},i.endText=e.isEverLogin?"我知道啦":"下一步";break;case"nineth":i.helpBoxClass="nineth",i.textBox={top:"50px"},i.helpText="点击保存按钮，保存图册",i.helpEnd=function(){i.step="disappear",$("#tipEnd").show()},i.prevText={display:"none"},i.endText="我知道啦";break;case"tenth":i.helpBoxClass="tenth",i.textBox={bottom:"100px"},i.helpText="点击插入图表，海量图表供你使用",i.helpEnd="",i.endText="下一步";break;case"demo":i.helpBoxClass="demo",i.textBox={top:"50px"},i.helpText="点击按钮添加资源框",i.helpEnd=function(){i.addWidgetWithoutPos(),i.step="demoSecond"},i.prevText={display:"none"},i.endText="下一步";break;case"demoSecond":i.helpBoxClass="disappear",i.textBox={bottom:"100px"},i.helpText="点击插入图表，海量图表供你使用",i.helpEnd=i.demoAddChart,i.endText="下一步",i.helpPrev=function(){i.step="demo"},setTimeout(function(){$(".edit-propriety").scrollTop(window.innerHeight);var e=$(".widget-box").last().width()/2+180-10;r.children().css("position","absolute"),r.children().css("left",e),r.children().css("bottom","94px"),r.children().css("display","block")},500);break;case"newSecond":i.helpBoxClass="disappear",i.textBox={bottom:"100px"},i.helpText="点击插入图表，海量图表供你使用",i.helpEnd=i.helpAddChart,i.prevText={display:"none"},i.endText="下一步",setTimeout(function(){var e=$(".gridster-item"),t=0==e.eq(1).length?e.eq(0).height():e.eq(1).height(),i=0==e.eq(1).length?e.eq(0).width():e.eq(1).width(),n=180+i/2,a=20+t/2;r.children().css("position","absolute"),r.children().css("display","block"),r.children().css("left",n+"px"),r.children().css("top",a+"px")},500);break;case"disappear":i.helpBoxClass="disappear";break;case"vip":i.helpBoxClass="vip",i.textBox={bottom:"100px"},i.helpText="充值会员，化身图表大咖~",i.helpEnd=i.closeHelp,i.endText="我知道啦";break;case"profile":i.helpBoxClass="info",i.textBox={bottom:"100px",color:"#58666e"},i.helpText="这里可以你的基本信息哦！",i.helpEnd=i.closeHelp,i.endText="我知道啦"}},i.closeHelp=function(){e.showHelpV3=!1,e.isEverLogin=!0,e.overhelp=!1},i.helpAddChart=function(){t.go("app.chart_instance_dashboard",{chartBookId:i.chartBookData.id,pageIndex:0,widgetIndex:0,curTheme:i.curTheme})},i.demoAddChart=function(){e.showHelpV3=!0,t.go("app.charting_chart_select",{compatVersion:2,bookId:i.chartBookData.id,bookName:i.chartBookData.name,pageIndex:0,widgetIndex:3})}}}}]).directive("draggableBox",["$rootScope","$state","StatisticsService",function(e,t,i){return{restrict:"AE",templateUrl:"tpl/charting/draggableBox.html",scope:"true",link:function(i,r,n){i.$on("draggable:move",function(){i.moveflag=!0}),i.$on("draggable:end",function(e,t){var r=$(".bottom_button"),n=r.position().top,a=window.innerHeight-165;t.tx>=-40&&t.tx<=40&&n>91&&a>n&&r.css("top",n+"px"),i.moveflag=!1});var a=function(){i.moveflag||window.open("https://jq.qq.com/?_wv=1027&k=5bvTuOA")},o=function(){i.moveflag||t.go("app.vip_intro")},s=function(){i.moveflag||window.open(e.helpServerUrl)},d=function(){i.moveflag||window.open(local_server+"/landing/feedback.html")};$("#help-button").on("mouseup",s),$("#feedback-button").on("mouseup",d),$("#addgroup_button").on("mouseup",a),$("#vip_button").on("mouseup",o)}}}]).directive("iconColorPicker",function(){return{restrict:"A",link:function(e,t,i){function r(t){t=t.toHexString(),e.$emit("iconColorChange",t)}e.palette=[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],t.spectrum({color:"#000",preferredFormat:"hex",showInput:!1,showInitial:!1,showPalette:!0,palette:e.palette,showSelectionPalette:!0,change:r}),$(".sp-cancel").text("取消"),$(".sp-choose").width("50px").text("确定")}}}).controller("selectExistChartCtrl",["$rootScope","$scope","$modalInstance","$timeout","chartInstanceDataManager","chartBookDataManager","themeService",function(e,t,i,r,n,a,o){t.chartInstancesData=[],t.seletChartIndex=0,t.processBgStyle=function(){-1!=t.chartCurTheme.define.background.indexOf("radial-gradient")?(navigator.userAgent.indexOf("MSIE")>0&&(_browserDetect.ie<10?t.bgStyle={background:"#3A3E41"}:t.bgStyle={background:"-ms-"+t.chartCurTheme.define.background}),Object.hasOwnProperty.call(window,"ActiveXObject")&&!window.ActiveXObject&&(t.bgStyle={background:"-ms-"+t.chartCurTheme.define.background}),navigator.userAgent.indexOf("Firefox")>0&&(t.bgStyle={background:"-moz-"+t.chartCurTheme.define.background}),navigator.userAgent.indexOf("Chrome")>0&&(t.bgStyle={background:"-webkit-"+t.chartCurTheme.define.background}),navigator.userAgent.indexOf("Opera")>0&&(t.bgStyle={background:"-o-"+t.chartCurTheme.define.background})):t.bgStyle={background:t.chartCurTheme.define.background}},t.selectExistChart=function(e){t.chartInstanceInfo=t.chartInstancesInfo[e],n.getById(t.chartInstanceInfo.id).then(function(i){t.chartInstancesData[e]=angular.copy(i),t.chartResource=t.chartInstancesData[e].widget.resource,o.queryThemes(t.chartInstancesData[e].id).then(function(i){t.chartTheme=i,t.chartInstancesData[e].curTheme=angular.copy(_.find(t.chartTheme,{id:t.chartInstancesData[e].themeId})),t.chartCurTheme=t.chartInstancesData[e].curTheme,t.chartThemeId=t.chartInstancesData[e].themeId,$(".chart.chartshowid")[0]&&datavizCharts.getInstanceByDom($(".chart.chartshowid")[0])&&datavizCharts.getInstanceByDom($(".chart.chartshowid")[0]).dispose(),t.processBgStyle(),t.$broadcast("drawChart")})}),t.selectChartIndex=e},r(function(){t.selectExistChart(0)}),t.confirm=function(){a.getById(t.bookId).then(function(r){var n=r.pages[t.pageIndex].layout.widget[t.widgetIndex];n.resource=angular.copy(t.chartResource),n.resource.id=UUID.prototype.createUUID(""),n.type="chart",n.props||(n.props={asFilter:!1,notAccept:!1}),e.isSavedToServer=!1,i.dismiss()})},t.dismiss=function(){i.dismiss()}}]);