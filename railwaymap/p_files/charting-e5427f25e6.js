/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2019.3.18
 ************************************************/
var charting=angular.module("charting",["ngResource","ngCookies","ngFileUpload","weixin-jssdk","ngDraggable","ui.bootstrap","common.dvAccordion","dataviz.chartedit.customProperties"]).constant("CHART_V1",1).constant("CHART_V2",2).constant("MEDIA_TYPES",{IMAGE:0,MUSIC:1,ICON:2}).factory("model",function(){return{chartBooksInfo:[{id:"string",originId:"string",ownerId:"string",name:"string",author:"string",category:"string",label:"string",version:"string",originAuthor:"string",modifiedOn:"Date",createdOn:"Date",desc:"string",iconStore:"string",sharing:null}],chartBookData:{id:"1",originId:"string",ownerId:"string",name:"string",author:"string",category:"string",label:"string",version:"string",originAuthor:"string",layoutRatio:1,modifiedOn:"Date",createdOn:"Date",desc:"string",iconStore:"string",isMyCoverImage:!1,iconStoreBase64:"string",themeId:1,background:{image:"string"},options:{showBorder:!1,margin:20},pages:[{index:null,interaction:[{from:"chartId",to:"chartId",type:"click",mapping:{fromField:"a",toField:"b"}}],layout:{id:null,widget:[{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"chart",resource:{id:1,originId:1,compId:1,name:null,version:null,category:null,desc:null,price:null,author:null,thumbnail:"url",interactive:3,options:[{category:"标题",props:[{title:"content",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"checkbox",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"副标题",props:[{title:"content",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"checkbox",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"图例",props:[{title:"绑定数据项",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"布局",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"透明度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图例项边距",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标形状",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"图标高度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字号",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"粗斜体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字颜色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"提示框",props:[{title:"背景色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"边框宽度",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"边框样式",type:"text",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"圆角半径",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"对齐方式",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字号",type:"number",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字字体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"粗斜体",type:"list",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"文字颜色",type:"color",defaultValue:"xxx",description:"xxx",value:"xxx"}]},{category:"其它属性",props:[{title:"content",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"margin",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontFamily",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontSize",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontWeight",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"},{title:"fontColor",type:"xxx",defaultValue:"xxx",description:"xxx",value:"xxx"}]}],codeStore:"url",userData:[["","Kia","Nissan","Toyota","Honda"],["2008",10,11,12,13],["2009",20,11,14,13],["2010",30,15,12,13]]}},{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"text",resource:{content:"xxx",fontSize:"xxx",fontFamily:"xxx",fontStyle:"xxx",fontWeight:"xxx",fontColor:"xxx"}},{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"},type:"image",resource:{imageStore:"url"}}]}}],musicMedia:{autoPlay:!1,musicMediaId:"string"}},layoutData:[{id:null,iconStore:null,widget:[{define:{sizeX:"number",sizeY:"number",row:"number",col:"number"}}]}],chartLibrary:[{id:null,name:null,version:null,category:null,desc:null,price:null,author:null,thumbnail:"url",codeStore:"url",interactive:3,crosstabAbility:1,dataCrosstab:1,userData:[["","Kia","Nissan","Toyota","Honda"],["2008",10,11,12,13],["2009",20,11,14,13],["2010",30,15,12,13]]}],categoryData:{chartBookCategory:[{id:0,name:"string"}],chartCategory:[{id:0,name:"string"}]}}}).factory("chartBooksInfoResource",["$resource",function(e){var t=charts_server+"/service/charting/chartbooksinfo/all",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("chartBookDataResource",["$resource",function(e){var t=charts_server+"/service/charting/chartbookdata/:id",r={update:{method:"PUT",params:{u:"@u"},isArray:!1}};return e(t,{},r)}]).factory("layoutResource",["$resource",function(e){var t=charts_server+"/service/charting/layoutdata/",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("chartLibraryResource",["$resource",function(e){var t=charts_server+"/service/charting/chartlibrary/",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("chartLibraryResourceV2",["$resource",function(e){var t=charts_server+"/service/charting/chartlibrary_v2",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("categoryResource",["$resource",function(e){var t=charts_server+"/service/charting/categorydata/",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("categoryResourceV2",["$resource",function(e){var t=charts_server+"/service/charting/categorydata_v2",r={query:{method:"GET",isArray:!1}};return e(t,{},r)}]).factory("favoritesResource",["$resource",function(e){var t=charts_server+"/service/social/favorites/chartbooksinfo",r={query:{method:"GET",isArray:!1},remove:{method:"DELETE",url:charts_server+"/service/social/favorite/:chartBookIds"}};return e(t,{},r)}]).factory("shareBooksInfoResource",["$resource",function(e){var t=charts_server+"/service/",r={query:{method:"GET",isArray:!1},queryshare:{method:"GET",url:charts_server+"/service/charting/sharewebsite/:chartBookIds"}};return e(t,{},r)}]).factory("chartBooksInfoManager",["chartBooksInfoResource","favoritesResource","shareBooksInfoResource","$q","model",function(e,t,r,o,a){var n=a.chartBooksInfo;return{query:function(){var t=o.defer();return e.query(function(e,r){e.error?t.reject(e.error):(n=e.object,t.resolve(n))},function(e,r){t.reject(e)}),t.promise},queryFavorites:function(){var e=o.defer();return t.query(function(t){t.error?e.reject(t.error):e.resolve(t.object)},function(t){e.reject(t)}),e.promise},removeFavorite:function(e){var r=o.defer();return t.remove({chartBookIds:e},function(e){e&&e.error?r.reject(e.error):r.resolve()},function(e){r.reject(e)}),r.promise},querysharing:function(e){var t=o.defer();return r.queryshare({chartBookIds:e},function(e){e&&e.error?t.reject(e.error):t.resolve(e.object)},function(e){t.reject(e)}),t.promise}}}]).factory("chartBookDataSortManager",["chartBooksInfoResource","$q","model",function(e,t,r){var o=r.chartBookData;return{sort:function(e){for(var r,a,n=t.defer(),i=o.pages,c=i.length,u=e.split(","),s=0;c>s;s++)if(s!=u[s]){r=s,a=u[s],i[r]=i.splice(a,1,i[r])[0];break}return n.resolve(),n.promise}}}]).factory("chartBookDataManager",["chartBookDataResource","MediaLibraryManager","$http","$q","model",function(e,t,r,o,a){var n=a.chartBookData;return{getById:function(t){var r=o.defer();return n.id==t?r.resolve(n):e.get({id:t},function(e,t){e.error?r.reject(e.error):(n=e.object,_.each(n.pages,function(e){_.each(e.layout.widget,function(e){if("chart"===e.type){var t=e.resource.userData;e.resource.userData=JSON.parse(t)}})}),a.chartBookData=n,r.resolve(n))},function(e,t){r.reject(e)}),r.promise},create:function(){var t=o.defer();return e.save({},function(e,r){e.error?t.reject(e.error):(n=e.object,t.resolve(n))},function(e,r){t.reject(e)}),t.promise},update:function(i,c,u){var s=o.defer();return e.update({u:c},i,function(e,o){e.error?s.reject(e.error):(u?(t.clearRefCount(),i.isMyCoverImage&&i.iconStore&&t.increaseRefCount(i.iconStore),i.musicMediaSaved&&i.musicMediaSaved.musicMediaSelect&&i.musicMediaSaved.musicMediaSelect.musicPath&&t.increaseRefCount(i.musicMediaSaved.musicMediaSelect.musicPath),r({method:"POST",url:charts_server+"/service/charting/resource/book/getlogoimg",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"chartbook_id="+i.id}).then(function(e){var r=angular.copy(e.data.object);r&&t.increaseRefCount(r),_.each(i.pages,function(e){e.options&&e.options.backgroundImage&&t.increaseRefCount(e.options.backgroundImage),e.options&&e.options.backgroundImageMobile&&t.increaseRefCount(e.options.backgroundImageMobile),_.each(e.layout.widget,function(e){"image"===e.type&&t.increaseRefCount(e.resource.imageStore)})}),t.updateRefCounts()})):t.updateRefCounts(),n=i,a.chartBookData=i,e.object?s.resolve(e.object):s.resolve())},function(e,t){s.reject(e)}),s.promise},"delete":function(a){var n=o.defer();return e["delete"]({id:a},function(e,o){if(e.error)n.reject(e.error);else{var a=e.object;t.clearRefCount(),_.each(a,function(e){e.isMyCoverImage&&e.iconStore&&t.decreaseRefCount(e.iconStore),e.musicMediaSaved&&e.musicMediaSaved.musicMediaSelect&&e.musicMediaSaved.musicMediaSelect.musicPath&&t.decreaseRefCount(e.musicMediaSaved.musicMediaSelect.musicPath),r({method:"POST",url:charts_server+"/service/charting/resource/book/getlogoimg",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},data:"chartbook_id="+e.id}).then(function(r){var o=angular.copy(r.data.object);o&&t.decreaseRefCount(o),_.each(e.pages,function(e){e.options&&e.options.backgroundImage&&t.decreaseRefCount(e.options.backgroundImage),e.options&&e.options.backgroundImageMobile&&t.decreaseRefCount(e.options.backgroundImageMobile),_.each(e.layout.widget,function(e){"image"===e.type&&t.decreaseRefCount(e.resource.imageStore)})}),t.updateRefCounts()})}),n.resolve()}},function(e,t){n.reject(e)}),n.promise}}}]).factory("layoutManager",["layoutResource","$q","model",function(e,t,r){var o=r.layoutData;return{getById:function(e){return _.findWhere(o,{id:e})},query:function(){var r=t.defer();return e.query(function(e,t){o=e.object,r.resolve(o)},function(e,t){r.reject(e)}),r.promise}}}]).factory("chartLibraryManager",["chartLibraryResource","chartLibraryResourceV2","categoryManager","CHART_V1","CHART_V2","$q","model","$http","$rootScope",function(e,t,r,o,a,n,i,c,u){function s(e){var t=n.defer();return e.simpleJson?t.resolve(e):c({method:"get",url:"assets/chart/json/"+e.compId+"/1_0/simple.json"}).then(function(r){r.data.error?console.error("getting chart json failed, compId: "+e.compId):(e.simpleJson=r.data,t.resolve(e))}),t.promise}function d(e){var t=n.defer();return e.userData?t.resolve(e):c({method:"get",url:"assets/chart/sample/"+e.compId+"/1_0/sampleData.json"}).then(function(r){r.data.error?console.error("getting chart sample data failed, compId: "+e.compId):(e.userData=r.data,t.resolve(e))}),t.promise}function l(e,t){var r=n.defer(),i=null;return!t||t==h&&0!==x.length?(i=_.findWhere(x,h==o?{id:e}:{compId:e}),h===a?s(i).then(function(e){d(e).then(function(e){r.resolve(e)})}):r.resolve(i)):this.query(t).then(function(){i=_.findWhere(x,h==o?{id:e}:{compId:e}),h===a&&s(i).then(function(e){d(e).then(function(e){r.resolve(e)})})}),r.promise}function f(c){var l=n.defer();if(x&&x.length>0&&h==c)l.resolve(x);else switch(c){case o:e.query(function(e,t){e.error?l.reject(e.error):(x=e.object,_.each(x,function(e){e.userData=JSON.parse(e.userData)}),i.chartLibrary=x,h=o,l.resolve(x))},function(e,t){l.reject(e)});break;case a:r.query(a).then(function(e){t.query(function(e,t){if(e.error)l.reject(e.error);else{x=e.object,i.chartLibrary=e,h=a;_.each(x,function(e){u.userinfo.limit.isfullcharts&&e.onSale&&(e.chartOwning?e.chartOwning.isExpired&&(e.chartOwning.isExpired=!1):e.chartOwning={isExpired:!1}),s(e).then(function(e){d(e).then(function(e){r()})})});var r=_.after(x.length,function(){l.resolve(x)})}},function(e,t){l.reject(e)})})}return l.promise}var x=[],h=a;return{getById:l,query:f}}]).factory("categoryManager",["categoryResource","categoryResourceV2","CHART_V1","CHART_V2","$q","model",function(e,t,r,o,a,n){var i={chartBookCategory:[],chartCategory:[]},c=o;return{getChartCategoryById:function(e){return _.findWhere(i.chartCategory,{id:e})},getChartBookCategoryById:function(e){return _.findWhere(i.chartBookCategory,{id:e})},query:function(u){var s=a.defer();if(i&&i.chartCategory.length>0&&c==u)s.resolve(i);else switch(u){case r:e.query(function(e,t){e.error?s.reject(e.error):(i=e.object,c=r,n.categoryData=e.object,s.resolve(i))},function(e,t){s.reject(e)});break;case o:t.query(function(e,t){e.error?s.reject(e.error):(i=e.object,c=o,n.categoryData=e.object,s.resolve(i))},function(e,t){s.reject(e)})}return s.promise}}}]).factory("userDataService",function(){function e(e,t){var r=[],o="行标题",a="列标题",n="数据值";if(angular.isArray(e)){if(e[0]&&"undefined"!=typeof e[0][0])if(t)for(var i=1,c=e.length;c>i;i++)for(var u=1,s=e[0].length;s>u;u++){var d={};d[a]=e[0][u],d[o]=e[i][0],d[n]=e[i][u],r.push(d)}else for(var i=1,c=e.length;c>i;i++){for(var d={},u=0,s=e[0].length;s>u;u++)d[e[0][u]]=e[i][u];r.push(d)}else r=e;return r}}function t(e,t){var r=[];if(t){e._header=e._header||["列标题","行标题","数据值"],r.push(e._header);for(var o=1,a=e.length;a>o;o++)for(var n=1,i=e[0].length;i>n;n++){var c=[];""!==e[o][n]&&(c.push(e[0][n]),c.push(e[o][0]),c.push(e[o][n]),r.push(c))}t=0}else{var u,s,d=1,l=1,f=[],x=[];r._header=e[0],r[d]=[],r[0]=[],r[0][0]="";for(var o=1,a=e.length;a>o;o++)for(var n=0,i=e[0].length;i>n;n++)0==n?void 0==r[0][l]?(r[0][l]=e[o][n])&&x.push(e[o][n]):-1!=(s=_.indexOf(x,e[o][n]))?l=s+1:(l=x.length+1)&&(r[0][l]=e[o][n])&&x.push(e[o][n]):1==n?void 0==r[d][0]?(r[d][0]=e[o][n])&&f.push(e[o][n]):-1!=(u=_.indexOf(f,e[o][n]))?d=u+1:(d=f.length+1)&&(r[d]=[])&&(r[d][0]=e[o][n])&&f.push(e[o][n]):null!==e[o][n]&&(r[d][l]=e[o][n]);t=1}return{newData:r,dataCrosstab:t}}return{array2json:e,cross2list:t}}).factory("interactionService",["chartBookDataManager","userDataService","model","$rootScope",function(e,t,r,o){var a=d3.map(),n=d3.map(),i=[];return{registerInteraction:function(r){e.getById(r).then(function(e){var r=e.pages;i.forEach(function(e){chartsshow.message.unsubscribe(e),i.pop(e)}),r.forEach(function(e){var r=e.interaction;e.layout.widget.forEach(function(e){"chart"==e.type&&(a.remove(e.resource.id),a.set(e.resource.id,e.resource.userData),n.remove(e.resource.id),n.set(e.resource.id,e.resource.dataCrosstab))}),r&&r.forEach(function(e,r){var c=e.from+"_click";i.push(c),chartsshow.message.subscribe(c,function(r){var i=r[e.mapping.fromField];if(i){var c=a.get(e.to),u=n.get(e.to),s=t.array2json(c,u),d={};d[e.mapping.toField]=i;var l=_.where(s,d);o.$broadcast("interactiveChart",{id:e.to,data:l})}})})})})},checkInteraction:function(e){a.remove(e)},refreshCharts:function(e){e.layout.widget.forEach(function(e){if("chart"==e.type){var r=a.get(e.resource.id),i=n.get(e.resource.id),c=t.array2json(r,i);o.$broadcast("interactiveChart",{id:e.resource.id,data:c})}})}}}]).factory("chartCodeCache",function(){var e=d3.map();return e}).factory("imgService",["$q","$http",function(e,t){return{generateImg:function(r,o,a,n,i,c){function u(){var e={};e.path=r,e.ratios=o,e.SERVERID=a,e.pageCount=c.pages.length,e.chartbookId=c.id,e.chartBookName=c.name,e.width=n;var i={url:charts_server+"/service/export/imgs/",method:"post",params:e};t(i).then(function(e){e.data.error?s.reject(e.data.error):s.resolve(e.data.object)},function(e){s.reject(e)})}var s=e.defer();return i?$(window).on("message",function(e){var r=e.originalEvent.data;if(r&&"RENDER_FINISHED"===r.msg){var o=r.charts;o.length?t.post(charts_server+"/service/export/image",o).then(function(e){e.data.error?s.reject(e.data.error):u()},function(e){s.reject(e)}):u(),i.src="",$(window).off("message",arguments.callee)}}):u(),s.promise}}}]).factory("imgManager",["imgService","$q",function(e,t){return{getImg:function(r){var o=t.defer();return e.query({path:r},function(e,t){e?o.resolve(e):o.reject("err")},function(e,t){o.reject(e)}),o.promise}}}]).factory("chartCleanManager",["$rootScope","$interval",function(e,t){function r(){e.ChartCache=e.ChartCache||[];for(var t=e.ChartCache.length-1;t>=0;t--)document.getElementById(e.ChartCache[t].domId)||(window.echarts.getInstanceById(e.ChartCache[t].echartId)&&window.echarts.getInstanceById(e.ChartCache[t].echartId).dispose(),e.ChartCache.splice(t,1))}t(function(){r()},3e4);return{storeChart:function(t,r){e.ChartCache=e.ChartCache||[];var o=r[0].getAttribute("_echarts_instance_");o&&e.ChartCache.push({domId:t,echartId:o})}}}]).factory("pdfService",["$resource","$http","$q",function(e,t,r){return{generatePdf:function(e,o,a,n,i){function c(){t.get(charts_server+"/service/export/pdf",{params:{path:e,ratio:o,SERVERID:a,width:n}}).then(function(e){e.data.error?u.reject(e.data.error):u.resolve(e.data.object)},function(e){u.reject(e)})}var u=r.defer();return i?$(window).on("message",function(e){var r=e.originalEvent.data;if(r&&"RENDER_FINISHED"===r.msg){var o=r.charts;o.length?t.post(charts_server+"/service/export/image",o).then(function(e){e.data.error?u.reject(e.data.error):c()},function(e){u.reject(e)}):c(),i.src="",$(window).off("message",arguments.callee)}}):c(),u.promise}}}]).factory("pdfManager",["chartBookDataManager","pdfService","imgService","$q","$http",function(e,t,r,o,a){function n(e){for(var t=!1,r=0,o=e.pages.length;o>r;r++)for(var a=e.pages[r].layout.widget,n=0,i=a.length;i>n;n++)if("chart"===a[n].type){var c=a[n].resource;-1!==tubiaoxiuOption.chartedit.echartsGLCharts.indexOf(c.compId)&&(t=!0)}return t}return{exportPdf:function(r,a,i){var c=o.defer(),u=local_server+"/export.html?print-pdf="+r,s=$(".whRatioDiv:first"),d=s[0].clientWidth/s[0].clientHeight;$(".whRatioDiv").each(function(e,t){var r=t.clientWidth/t.clientHeight;d>r&&(d=r)});var l="";if(document.cookie.length>0){var f=document.cookie.indexOf("SERVERID=");if(-1!=f){f+=9;var x=document.cookie.indexOf(";",f);-1==x&&(x=document.cookie.length),l=document.cookie.substring(f,x)}}var h="iframe-for-tubiaoxiu-export",v=document.getElementById(h);v||(v=document.createElement("iframe"),v.setAttribute("id",h),v.setAttribute("name",h),v.style.position="absolute",v.style.top="0px",v.style.border="none",v.style.visibility="hidden",document.body.appendChild(v));var p;return e.getById(r).then(function(e){p=e;var r=n(p);r&&(v.style.width=i+"px",v.style.height=i/d+"px",v.src=u+"&shot=true");var o=t.generatePdf(u,d,l,i,r?v:void 0);o.then(function(e){e.error&&c.reject("err");var t=!1;(navigator.userAgent.indexOf("MSIE")>0||navigator.userAgent.indexOf("rv:11.0")>0)&&(t=!0);var r=charts_server+"/service/export/gpdf",o=document.createElement("form");o.action=r,o.target="_self",o.method="post";var n=document.createElement("input");n.type="hidden",n.name="path",n.value=e,o.appendChild(n);var i=document.createElement("input");i.type="hidden",i.name="isIe",i.value=t,o.appendChild(i);var u=document.createElement("input");u.type="hidden",u.name="exportName",u.value=a,o.appendChild(u),document.body.appendChild(o),o.submit(),document.body.removeChild(o),c.resolve(e)})}),c.promise},exportImgs:function(e,t,r){var n=o.defer(),i=local_server+"/export.html?print-pdf="+e,c=$(".whRatioDiv:first"),u=c[0].clientWidth/c[0].clientHeight;$(".whRatioDiv").each(function(e,t){var r=t.clientWidth/t.clientHeight;u>r&&(u=r)});var s="";if(document.cookie.length>0){var d=document.cookie.indexOf("SERVERID=");if(-1!=d){d+=9;var l=document.cookie.indexOf(";",d);-1==l&&(l=document.cookie.length),s=document.cookie.substring(d,l)}}var f={};f.path=i,f.ratios=u,f.SERVERID=s,f.pageCount=t,f.chartbookId=e,f.width=r;var x={url:charts_server+"/service/export/imgs/",method:"post",params:f};return a(x).then(function(e){e.error&&n.reject("err"),n.resolve("success")},function(e){n.reject("err")}),n.promise},exportImgsZip:function(t,a,i,c,u){var s=o.defer(),d=1920,l=1280,f=local_server+"/export.html?print-pdf="+t,x=$(".whRatioDiv:first"),h=x[0].clientWidth/x[0].clientHeight;$(".whRatioDiv").each(function(e,t){var r=t.clientWidth/t.clientHeight;h>r&&(h=r)});var v=1;u?(v=d/c,f=f+"&largeRatio="+v,c=d):(v=l/c,f=f+"&largeRatio="+v,c=l);var p="";if(document.cookie.length>0){var m=document.cookie.indexOf("SERVERID=");if(-1!=m){m+=9;var g=document.cookie.indexOf(";",m);-1==g&&(g=document.cookie.length),p=document.cookie.substring(m,g)}}var y="iframe-for-tubiaoxiu-export",b=document.getElementById("iframeName");b||(b=document.createElement("iframe"),b.setAttribute("id",y),b.setAttribute("name",y),b.style.position="absolute",b.style.top="0px",b.style.border="none",b.style.visibility="hidden",document.body.appendChild(b));var C;return e.getById(t).then(function(e){C=e;var o=n(C);o&&(b.style.width=c+"px",b.style.height=c/h+"px",b.src=f+"&shot=true");var a=r.generateImg(f,h,p,c,o?b:void 0,C);a.then(function(e){if(e.error&&s.reject("err"),C.pages.length>1){var r=charts_server+"/service/export/getimgszip",o=document.createElement("form");o.action=r,o.target="_self",o.method="post";var a=document.createElement("input");a.type="hidden",a.name="code",a.value=t,o.appendChild(a),document.body.appendChild(o),o.submit(),document.body.removeChild(o),s.resolve("success")}else{var n=!1;(navigator.userAgent.indexOf("MSIE")>0||navigator.userAgent.indexOf("rv:11.0")>0)&&(n=!0);var r=charts_server+"/service/export/saveimg",o=document.createElement("form");o.action=r,o.target="_self",o.method="post";var a=document.createElement("input");a.type="hidden",a.name="code",a.value=t,o.appendChild(a);var c=document.createElement("input");c.type="hidden",c.name="exportName",c.value=i,o.appendChild(c);var u=document.createElement("input");u.type="hidden",u.name="isIe",u.value=n,o.appendChild(u),document.body.appendChild(o),o.submit(),document.body.removeChild(o),s.resolve("success")}},function(e){s.reject("err")})}),s.promise},exportPpt:function(t,a,i){var c=o.defer(),u=local_server+"/export.html?print-pdf="+t,s=$(".whRatioDiv:first"),d=s[0].clientWidth/s[0].clientHeight;$(".whRatioDiv").each(function(e,t){var r=t.clientWidth/t.clientHeight;d>r&&(d=r)});var l="";if(document.cookie.length>0){var f=document.cookie.indexOf("SERVERID=");if(-1!=f){f+=9;var x=document.cookie.indexOf(";",f);-1==x&&(x=document.cookie.length),l=document.cookie.substring(f,x)}}var h="iframe-for-tubiaoxiu-export",v=document.getElementById("iframeName");v||(v=document.createElement("iframe"),v.setAttribute("id",h),v.setAttribute("name",h),v.style.position="absolute",v.style.top="0px",v.style.border="none",v.style.visibility="hidden",document.body.appendChild(v));var p;return e.getById(t).then(function(e){p=e;var o=n(p);o&&(v.style.width=i+"px",v.style.height=i/d+"px",v.src=u+"&shot=true");var a=r.generateImg(u,d,l,i,o?v:void 0,p);a.then(function(e){e.error&&c.reject("err");var r=charts_server+"/service/export/getppt",o=document.createElement("form");o.action=r,o.target="_self",o.method="post";var a=document.createElement("input");a.type="hidden",a.name="code",a.value=t,o.appendChild(a),document.body.appendChild(o),o.submit(),document.body.removeChild(o),c.resolve("success")},function(e){c.reject("err")})}),c.promise},exportHtmlZip:function(e){var t=o.defer(),r=!1;(navigator.userAgent.indexOf("MSIE")>0||navigator.userAgent.indexOf("rv:11.0")>0)&&(r=!0);var a=charts_server+"/service/export/gethtmlzip",n=document.createElement("form");n.action=a,n.target="_self",n.method="post";var i=document.createElement("input");i.type="hidden",i.name="file",i.value=e,n.appendChild(i);var c=document.createElement("input");return c.type="hidden",c.name="isIe",c.value=r,n.appendChild(c),document.body.appendChild(n),n.submit(),document.body.removeChild(n),t.promise},exportHtmlSingle:function(e,t){var r=o.defer(),a=!1;(navigator.userAgent.indexOf("MSIE")>0||navigator.userAgent.indexOf("rv:11.0")>0)&&(a=!0);var n=charts_server+"/service/export/gethtmlsingle",i=document.createElement("form");i.action=n,i.target="_self",i.method="post";var c=document.createElement("input");c.type="hidden",c.name="file",c.value=e,i.appendChild(c);var u=document.createElement("input");u.type="hidden",u.name="isIe",u.value=a,i.appendChild(u);var s=document.createElement("input");return s.type="hidden",s.name="filesToLoad",s.value=t.join(","),i.appendChild(s),document.body.appendChild(i),i.submit(),document.body.removeChild(i),r.promise}}}]).factory("chartEngineManager",["$ocLazyLoad","$timeout","$q","CHART_V1","CHART_V2",function(e,t,r,o,a){function n(){return{engine_v2_base:{pro_path:["js/chartPro/dvChartConfig.js","js/chartPro/vendor.js","js/chartPro/dvCharts.js"],dev_path:["js/chartDev/dvChartConfig.js","js/chartDev/vendor.js","js/chartDev/dvCharts.js"]}}}function i(e,t){var r=cas_server&&cas_server.length,o=[],a=n(t),i="undefined"==typeof echarts||"2.2.7"===echarts.version,c=t?"src/":"";if(t||i)for(var u in a)(i&&"engine_v2_base"===u||!e||a.hasOwnProperty(u)&&_.intersection(a[u].compIds,e).length)&&_.each(r?a[u].pro_path:a[u].dev_path,function(e){o.push(c+e)});return o}function c(t,n,c){var u=r.defer(),s="",d="js/charts_v1/datavizjs/dataviz/dataviz.config.js";switch(n&&(s="src/",d="js/charts_v1/datavizjs/dataviz/play.dataviz.config.js"),t){case o:if("undefined"==typeof echarts||"2.2.7"!==echarts.version){if($("#loading-mask").show(),"undefined"!=typeof define){var l=define;define=void 0}if("undefined"!=typeof require){var f=require;require=void 0}if("undefined"!=typeof requirejs){var x=requirejs;requirejs=void 0}return e.load([{files:[s+"js/charts_v1/chartsshow-e755937343.js"],cache:!0},{files:[s+"js/charts_v1/echarts/echarts-all-03788e51fe.js",s+"js/charts_v1/echarts/option-d5b3be5458.js",s+"../bower_components/requirejs/require.js",s+d],cache:!1,serie:!0}]).then(function(){"undefined"==typeof define&&(define=l),"undefined"==typeof require&&(require=f),"undefined"==typeof requirejs&&(requirejs=x),l=void 0,f=void 0,x=void 0,$("#loading-mask").hide(),u.resolve()})}u.resolve();case a:if("undefined"==typeof datavizCharts){var h=i(c,n);if(h.length){if($("#loading-mask").show(),"undefined"!=typeof define){var l=define;define=void 0}if("undefined"!=typeof require){var f=require;require=void 0}if("undefined"!=typeof requirejs){var x=requirejs;requirejs=void 0}return e.load([{files:h,cache:!1,serie:!0}]).then(function(){"undefined"==typeof define&&(define=l),"undefined"==typeof require&&(require=f),"undefined"==typeof requirejs&&(requirejs=x),l=void 0,f=void 0,x=void 0,$("#loading-mask").hide(),u.resolve()})}u.resolve()}else u.resolve()}return u.promise}return{chartClusters:n,loadEngine:c}}]);