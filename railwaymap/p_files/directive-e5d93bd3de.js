/*!***********************************************
 Copyright (c) 2016, Neusoft Inc.
 All rights reserved
 图表秀 Version 1.0.0 2019.3.18
 ************************************************/
playChartBook.directive("revealInit",function(){return{restrict:"A",scope:{isLast:"=isLast",slidesWidth:"=slidesWidth",slidesHeight:"=slidesHeight",progress:"=showProgress"},link:function(e,t){e.isMobile=!!navigator.userAgent.match(/AppleWebKit.*Mobile.*/),e.isLast&&(Reveal.initialize({controls:!0,progress:!!e.progress,history:!0,center:!0,width:e.slidesWidth,height:e.slidesHeight,margin:0,minScale:1,maxScale:1,viewDistance:100,overview:!0,touch:!0,embedded:!1,transition:(e.isMobile,"slide"),backgroundTransition:"slide"}),Reveal.addEventListener("slidechanged",function(e){$(".reveal").scrollTop(0).scrollLeft(0).perfectScrollbar("update")}))}}}).directive("playWidget",["$rootScope","$http","userDataService","themeService",function($rootScope,$http,userDataService,themeService){return{restrict:"AE",replace:!0,scope:{type:"=type",resource:"=resource",widgetIndex:"=widgetIndex",themeData:"=themeData",fontSize:"=fontSize"},template:'<div class="widget-box"><div class="widget-box-content" style="width:100%;height:100%" ng-style="{color: themeData.define.text;font-size: fontSize}"></div></div>',link:function(scope,element){function update(jsonData,width,height){var doUpdate=function(jsCode){var re=/('|")\s*click\s*('|")/g,newStr="'"+scope.resource.id+"_click'",newCode=jsCode.replace(re,newStr);themeService.themeColorSwitch(scope.resource.compId),eval(newCode),scope.chart=chartsshow.charts,handleOptions();var dd=$("<div></div>");dd.css("width",width+"px"),dd.css("height",height+"px"),contentBody.empty().append(dd),d3.select(dd[0]).datum(jsonData).call(scope.chart)},chartName=scope.resource.codeStore.substring(scope.resource.codeStore.lastIndexOf("/")+1).split(".")[0],$code=$("script#"+chartName);$code.length?doUpdate($($code[0]).text()):$http.get(scope.resource.codeStore).success(doUpdate).error(function(e){console.error(scope.resource.codeStore+":"+e+" 获取失败")})}function handleOptions(){if(scope.resource.options){var e=[];for(var t in scope.resource.options)e=e.concat(scope.resource.options[t].props);var i=scope.chart.options();for(var t in i){var r=i[t],o=r.category(),s=r.title(),a=_.findWhere(e,{category:o,title:s});a&&(r.value=a.value)}}}function buildStandJson(e){return _.each(e,function(e){string2Number(e)}),e}function string2Number(e){for(var t in e){var i=/^(-?\d+)(\.\d+)?$/;if(i.test(e[t])){var r=parseFloat(e[t]);isNaN(r)||(e[t]=r)}}}function drawChart(e,t){var i=userDataService.array2json(scope.resource.userData,scope.resource.dataCrosstab),r=buildStandJson(i);update(r,e,t)}function drawChartWithNewData(e,t,i){var i=userDataService.array2json(i,scope.resource.dataCrosstab),r=buildStandJson(i);update(r,e-20,t-20)}var contentBody=element.find(".widget-box-content");if(scope.$on("interactiveChart",function(e,t){if(scope.resource&&t.id==scope.resource.id){var i=scope.width,r=scope.height;drawChartWithNewData(i,r,t.data)}}),"chart"==scope.type&&scope.$on("gridster-item-initialized",function(e,t){scope.$on("renderWidget",function(){var e=t.sizeX*scope.$parent.gridCellWidth,i=t.sizeY*scope.$parent.gridCellWidth;scope.width=e,scope.height=i,scope.sizeX=t.sizeX,scope.sizeY=t.sizeY,drawChart(e-5,i-5)}),scope.$emit("widgetReady")}),"image"==scope.type&&"{}"!=scope.resource){var ele=angular.element(document.createElement("img"));ele.attr("src",scope.resource.imageStore.split("@")[0]),ele.css({maxWidth:"100%",maxHeight:"100%",height:"auto",width:"auto"}),contentBody.html(ele),scope.$emit("widgetReady")}else if("text"==scope.type){var textOuter=$("<div class='widget-box-text' ></div>");textOuter.append(scope.resource.content);var wrapper=$("<div style='display:table; height:100%; width: 100%; overflow-y: auto'></div>").append(textOuter);contentBody.html(wrapper),scope.$emit("widgetReady")}}}}]).directive("playWidgetV2",["$sce","$rootScope",function(e,t){return{restrict:"AE",replace:!0,scope:{widget:"=",curTheme:"=",mode:"@",largeTextRatio:"=",textFontSize:"="},template:'<div class="widget-box">    <div class="widget-box-content" style="width: 100%; height: 100%" ng-style="{color : curTheme.define.text}">        <div ng-switch="widget.type" style="width: 100%; height: 100%">            <div ng-switch-when="chart" style="width: 100%; height: 100%">                <div id="{{widget.resource.id}}"                     dataviz-chart class="pos-rlt h-full w-full chartdom"                     chart-obj="widget.resource"                     theme-id="curTheme.id"                     widget="widget"                     mode = "chartMode"                     large-text-ratio = "text.largeRatio">                </div>            </div>            <div ng-switch-when="text" class="widget-box-text" ng-bind-html="trustAsHtml(widget.resource.content)" style="font-family: \'微软雅黑\', \'Microsoft Yahei\', sans-serif, Arial, Verdana, \'Trebuchet MS\';  font-size:{{textFontSize}}"></div>            <img ng-switch-when="image" ng-src="{{widget.resource.imageStore}}" style="max-width: 100%;max-height: 100%;"/>            <div ng-switch-when="icon" class="h-full w-full">                 <span style="color: {{widget.resource.setIconContent}}">                     <span ng-class="widget.resource.iconContent" style="font-size: {{widget.resource.iconFontSize + \'px\'}}">                     </span></span>            </div>            <div ng-switch-default></div>        </div>    </div></div>',link:function(i,r,o){function s(e){i.sizeX=e.sizeX,i.sizeY=e.sizeY}function a(){i.width=i.sizeX*i.$parent.gridCellWidth-i.$parent.gridCellMargin,i.height=i.sizeY*Math.round(i.$parent.gridCellWidth)-i.$parent.gridCellMargin,$("#chart"+i.widget.resource.id).css("width",i.width+"px").css("height",i.height+"px").parent().css("width",i.width+"px").css("height",i.height+"px"),$("#chart"+i.widget.resource.id+" .chartdom").css("width",i.width-d-n+"px").css("height",i.height-d-n+"px"),h&&i.$broadcast("drawChart")}i.trustAsHtml=e.trustAsHtml;var c=$(".widget-box-content").first(),d=2*parseInt(c.parent().css("borderLeftWidth")),n=20;if(i.chartMode=i.mode,i.text={},i.text.largeRatio=t.largeTextRatio,"chart"===i.widget.type){var h=!1;$(r).attr("id","chart"+i.widget.resource.id),$(r).attr("name",i.widget.resource.simpleJson.option.name);var l=i.$on("gridster-item-initialized",function(e,t){s(t),i.$on("gridster-item-resized",function(e,t){s(t)}),i.$on("renderWidget",function(){a()}),i.$on("chartReadyToRender",function(e){e.stopPropagation&&e.stopPropagation(),h=!0}),i.$emit("widgetReady")});i.$on("destroy",function(){l()})}else"image"===i.widget.type&&(i.widget.resource.imageStore=i.widget.resource.imageStore.split("@")[0])}}}]).directive("playChartInstance",["$sce","$rootScope","$timeout",function(e,t,i){return{restrict:"AE",replace:!0,scope:{widget:"=",curTheme:"=",mode:"@"},template:'<div class="pos rlt h-full w-full">\n    <div class="h-full w-full" dataviz-chart chart-obj="widget.resource" theme-id="curTheme.id" mode="mode"></div>\n</div>',link:function(e,t,i){$(t).attr("id","chart"+e.widget.resource.id),$(t).attr("name",e.widget.resource.simpleJson.option.name);e.widget.define.width/e.widget.define.height;e.whStyle={},e.$on("renderChartWidget",function(t){e.$broadcast("drawChart")})}}}]).directive("mobileShow",function(){return{restrict:"A",link:function(e,t){var i=e.$watch("showMobileAdPage",function(e){e===!1&&(t.remove(),i())})}}}).directive("sidebar",[function(){return{restrict:"AE",replace:!0,templateUrl:"src/tpl/playchartbook/chartBookSidebar.html",controller:"sidebarController"}}]);